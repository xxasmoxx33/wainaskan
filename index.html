<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙˆÙŠÙ† Ø£Ø³ÙƒÙ† - Ø§ÙƒØªØ´Ù Ø£ÙØ¶Ù„ Ù…Ù†Ø·Ù‚Ø© Ù„Ù„Ø³ÙƒÙ† ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶</title>
    <meta name="description" content="Ø£Ø¯Ø§Ø© Ø°ÙƒÙŠØ© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø³ÙƒÙ† ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù…Ø§ÙƒÙ†Ùƒ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©">
    <meta name="keywords" content="ÙˆÙŠÙ† Ø£Ø³ÙƒÙ†, Ø³ÙƒÙ† Ø§Ù„Ø±ÙŠØ§Ø¶, Ø£ÙØ¶Ù„ Ø­ÙŠ Ù„Ù„Ø³ÙƒÙ†, Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="ÙˆÙŠÙ† Ø£Ø³ÙƒÙ† - Ø§ÙƒØªØ´Ù Ø£ÙØ¶Ù„ Ù…Ù†Ø·Ù‚Ø© Ù„Ù„Ø³ÙƒÙ† ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶">
    <meta property="og:description" content="Ø£Ø¯Ø§Ø© Ø°ÙƒÙŠØ© ØªØ­Ø³Ø¨ Ù„Ùƒ Ø£ÙØ¶Ù„ Ù…Ù†Ø·Ù‚Ø© Ù„Ù„Ø³ÙƒÙ† ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù…Ø§ÙƒÙ†Ùƒ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    <link rel="canonical" href="https://weeenaskn.com/">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --green: #10b981;
            --green-dark: #059669;
            --green-light: #6ee7b7;
            --amber: #f59e0b;
            --red: #ef4444;
            --bg: #0a1628;
            --glass: rgba(255,255,255,0.06);
            --glass-border: rgba(255,255,255,0.1);
            --text: #fff;
            --text-dim: rgba(255,255,255,0.5);
            --text-dimmer: rgba(255,255,255,0.3);
            --radius: 14px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* ===== MAP FULLSCREEN ===== */
        #map {
            position: fixed;
            inset: 0;
            z-index: 1;
            cursor: crosshair;
        }

        .leaflet-control-zoom { margin-top: 70px !important; }
        .leaflet-control-zoom a {
            background: rgba(10,20,30,0.85) !important;
            color: #fff !important;
            border-color: var(--glass-border) !important;
            backdrop-filter: blur(10px);
            width: 36px !important; height: 36px !important;
            line-height: 36px !important; font-size: 18px !important;
        }
        .leaflet-control-zoom a:hover { background: rgba(16,185,129,0.3) !important; }
        .leaflet-control-attribution {
            background: rgba(10,20,30,0.6) !important;
            color: rgba(255,255,255,0.3) !important;
            font-size: 9px !important;
            padding: 2px 6px !important;
        }
        .leaflet-control-attribution a { color: rgba(255,255,255,0.4) !important; }

        /* ===== TOP BAR (Logo + Lang) ===== */
        .top-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: linear-gradient(180deg, rgba(10,22,40,0.9) 0%, transparent 100%);
            pointer-events: none;
        }
        .top-bar > * { pointer-events: auto; }

        .top-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .top-logo {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(16,185,129,0.3);
        }
        .top-title {
            font-size: 17px; font-weight: 800;
            background: linear-gradient(135deg, var(--green), var(--green-light));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .top-actions { display: flex; gap: 6px; }
        .lang-btn {
            padding: 5px 14px; border-radius: 50px;
            border: 1px solid var(--glass-border);
            background: rgba(10,20,30,0.7); backdrop-filter: blur(10px);
            color: var(--text-dim); font-family: 'Cairo'; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .lang-btn.active {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border-color: transparent; color: #fff;
        }

        /* ===== ADD FORM OVERLAY (on map) ===== */
        .add-overlay {
            position: fixed;
            bottom: calc(24px + var(--safe-bottom));
            left: 12px; right: 12px;
            z-index: 800;
            background: rgba(10,20,35,0.92);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 18px 16px;
            transform: translateY(120%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .add-overlay.show { transform: translateY(0); }

        .add-overlay-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .add-overlay-neighborhood {
            font-size: 12px; color: var(--green-light); font-weight: 600;
            display: flex; align-items: center; gap: 4px;
        }
        .add-overlay-close {
            width: 30px; height: 30px; border-radius: 50%;
            border: none; background: rgba(255,255,255,0.1);
            color: var(--text-dim); font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .add-name-input {
            width: 100%; padding: 14px 16px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--glass-border);
            border-radius: 12px; color: #fff;
            font-family: 'Cairo'; font-size: 16px; font-weight: 600;
            outline: none; transition: all 0.3s;
            margin-bottom: 10px;
        }
        .add-name-input:focus {
            border-color: var(--green);
            background: rgba(16,185,129,0.1);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
        }
        .add-name-input::placeholder { color: var(--text-dimmer); }

        .quick-row {
            display: flex; gap: 6px; margin-bottom: 12px;
        }
        .quick-btn {
            flex: 1; padding: 10px 6px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px; color: var(--text-dim);
            font-family: 'Cairo'; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .quick-btn:active { transform: scale(0.95); }
        .quick-btn .q-icon { font-size: 18px; }
        .quick-btn.selected {
            background: rgba(16,185,129,0.15);
            border-color: var(--green); color: var(--green-light);
        }

        .freq-row {
            display: flex; gap: 8px; margin-bottom: 14px;
        }
        .freq-btn {
            flex: 1; padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px; color: var(--text-dim);
            font-family: 'Cairo'; font-size: 13px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
            text-align: center;
        }
        .freq-btn:active { transform: scale(0.95); }
        .freq-btn.selected {
            background: rgba(16,185,129,0.15);
            border-color: var(--green); color: var(--green-light);
        }

        .add-confirm-btn {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border: none; border-radius: 12px;
            color: #fff; font-family: 'Cairo'; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .add-confirm-btn:active { transform: scale(0.97); }

        /* ===== MAP HINT ===== */
        .map-hint {
            position: fixed;
            bottom: calc(30px + var(--safe-bottom));
            left: 50%; transform: translateX(-50%);
            z-index: 700;
            background: rgba(10,20,35,0.88);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 13px; font-weight: 600;
            color: var(--text-dim);
            display: flex; align-items: center; gap: 8px;
            animation: hintPulse 3s ease infinite;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .map-hint.hidden { opacity: 0; pointer-events: none; }
        .map-hint-icon { font-size: 20px; animation: hintBounce 2s ease infinite; }

        @keyframes hintPulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.2); }
            50% { box-shadow: 0 0 0 10px rgba(16,185,129,0); }
        }
        @keyframes hintBounce {
            0%,100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* ===== RESULT FAB (floating button) ===== */
        .result-fab {
            position: fixed;
            bottom: calc(24px + var(--safe-bottom));
            left: 16px;
            z-index: 800;
            display: none;
            align-items: center; gap: 8px;
            padding: 14px 22px;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border: none; border-radius: 50px;
            color: #fff; font-family: 'Cairo'; font-size: 14px; font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 25px rgba(16,185,129,0.4);
            transition: all 0.3s;
            animation: fabPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .result-fab.show { display: flex; }
        .result-fab:active { transform: scale(0.95); }
        .result-fab .fab-icon { font-size: 18px; }
        .result-fab .fab-count {
            background: rgba(255,255,255,0.25);
            padding: 2px 8px; border-radius: 50px;
            font-size: 11px;
        }

        @keyframes fabPop {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* ===== SIDEBAR DRAWER ===== */
        .sidebar-backdrop {
            position: fixed; inset: 0; z-index: 999;
            background: rgba(0,0,0,0.5);
            opacity: 0; visibility: hidden;
            transition: all 0.3s;
        }
        .sidebar-backdrop.show { opacity: 1; visibility: visible; }

        .sidebar-drawer {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 340px; max-width: 85vw;
            z-index: 1000;
            background: rgba(10,20,35,0.97);
            backdrop-filter: blur(30px);
            border-inline-start: 1px solid var(--glass-border);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            overflow-y: auto;
            display: flex; flex-direction: column;
        }
        [dir="ltr"] .sidebar-drawer { right: auto; left: 0; transform: translateX(-100%); }
        .sidebar-drawer.show { transform: translateX(0); }

        .sidebar-header {
            padding: 20px 18px 14px;
            border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-title {
            font-size: 17px; font-weight: 800;
            background: linear-gradient(135deg, var(--green), var(--green-light));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .sidebar-close {
            width: 34px; height: 34px; border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
            color: var(--text-dim); font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .sidebar-body { flex: 1; padding: 16px 18px; overflow-y: auto; }

        .sidebar-locations { display: flex; flex-direction: column; gap: 8px; }

        .sidebar-loc-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 12px;
            display: flex; align-items: center; gap: 10px;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sloc-icon {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0;
        }
        .sloc-info { flex: 1; min-width: 0; }
        .sloc-name { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sloc-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .sloc-freq-badge {
            font-size: 10px; padding: 2px 8px; border-radius: 50px; font-weight: 600;
        }
        .sloc-delete {
            width: 28px; height: 28px; border-radius: 8px;
            border: none; background: rgba(255,255,255,0.05);
            color: var(--text-dimmer); font-size: 14px;
            cursor: pointer; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .sloc-delete:active { background: rgba(239,68,68,0.2); color: var(--red); }

        .sidebar-empty {
            text-align: center; padding: 40px 16px;
            color: var(--text-dimmer);
        }
        .sidebar-empty-icon { font-size: 36px; margin-bottom: 10px; }
        .sidebar-empty p { font-size: 13px; line-height: 1.6; }

        /* ===== SIDEBAR CALCULATE BTN ===== */
        .sidebar-calc-btn {
            margin: 16px 18px 20px;
            padding: 16px;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border: none; border-radius: 14px;
            color: #fff; font-family: 'Cairo'; font-size: 16px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .sidebar-calc-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .sidebar-calc-btn:active:not(:disabled) { transform: scale(0.97); }

        /* ===== SIDEBAR TOGGLE BUTTON ===== */
        .sidebar-toggle {
            position: fixed;
            top: 50%; right: 0;
            transform: translateY(-50%);
            z-index: 800;
            width: 32px; height: 70px;
            background: rgba(10,20,35,0.88);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-right: none;
            border-radius: 12px 0 0 12px;
            color: var(--text-dim); font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center; justify-content: center;
            flex-direction: column; gap: 4px;
            transition: all 0.3s;
        }
        [dir="ltr"] .sidebar-toggle { right: auto; left: 0; border-radius: 0 12px 12px 0; border-left: none; border-right: 1px solid var(--glass-border); }
        .sidebar-toggle.show { display: flex; }
        .sidebar-toggle:active { background: rgba(16,185,129,0.15); }
        .sidebar-toggle .toggle-count {
            font-size: 11px; font-weight: 800; color: var(--green-light);
        }
        .sidebar-toggle .toggle-icon { font-size: 12px; }

        /* ===== RESULT OVERLAY ===== */
        .result-overlay {
            position: fixed; inset: 0; z-index: 1100;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: none; align-items: flex-end; justify-content: center;
        }
        .result-overlay.show { display: flex; }

        .result-sheet {
            width: 100%; max-width: 500px;
            max-height: 90vh;
            background: rgba(10,20,35,0.97);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 24px 24px 0 0;
            overflow-y: auto;
            animation: sheetUp 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }
        @keyframes sheetUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .result-sheet-handle {
            width: 36px; height: 4px; border-radius: 4px;
            background: rgba(255,255,255,0.15);
            margin: 10px auto 0;
        }

        .result-sheet-body { padding: 20px 18px calc(20px + var(--safe-bottom)); }

        .result-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: rgba(16,185,129,0.2); color: var(--green-light);
            padding: 4px 12px; border-radius: 50px;
            font-size: 11px; font-weight: 700; margin-bottom: 12px;
        }
        .result-neighborhood {
            font-size: 22px; font-weight: 800; margin-bottom: 6px; line-height: 1.3;
        }
        .result-desc {
            font-size: 13px; color: var(--text-dim); line-height: 1.6; margin-bottom: 16px;
        }

        .result-justification {
            background: rgba(16,185,129,0.06);
            border: 1px solid rgba(16,185,129,0.12);
            border-radius: 12px; padding: 14px; margin-bottom: 16px;
        }
        .just-title { font-size: 12px; font-weight: 700; color: var(--green-light); margin-bottom: 8px; }
        .just-point { display: flex; gap: 6px; margin-bottom: 8px; font-size: 12px; color: var(--text-dim); line-height: 1.7; }
        .just-point strong { color: rgba(255,255,255,0.85); }
        .just-point span:first-child { color: var(--green); flex-shrink: 0; }

        .result-distances { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
        .rdist-item {
            background: var(--glass); border-radius: 10px; padding: 10px 12px;
        }
        .rdist-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        .rdist-name { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 700; flex: 1; min-width: 0; }
        .rdist-name span:last-child { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rdist-km { font-weight: 700; color: var(--green-light); font-size: 13px; direction: ltr; }
        .rdist-times { display: flex; gap: 6px; flex-wrap: wrap; }
        .rdist-time {
            display: inline-flex; align-items: center; gap: 3px;
            font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 6px; direction: ltr;
        }
        .rdist-normal { background: rgba(16,185,129,0.1); color: var(--green-light); }
        .rdist-rush { background: rgba(239,68,68,0.1); color: #fca5a5; }

        .result-actions { display: flex; gap: 8px; margin-bottom: 20px; }
        .result-btn {
            flex: 1; padding: 12px;
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 10px; color: var(--text-dim);
            font-family: 'Cairo'; font-size: 13px; font-weight: 600;
            cursor: pointer; text-align: center;
        }
        .result-btn:active { background: rgba(255,255,255,0.1); }

        /* ===== BROKER SECTION (inside result) ===== */
        .broker-divider {
            height: 1px; background: var(--glass-border); margin: 4px 0 18px;
        }
        .broker-title {
            font-size: 16px; font-weight: 800; margin-bottom: 4px; text-align: center;
        }
        .broker-desc {
            font-size: 12px; color: var(--text-dim); text-align: center; margin-bottom: 16px; line-height: 1.6;
        }

        .broker-q-label {
            font-size: 13px; font-weight: 700; color: var(--text-dim); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .broker-q-num {
            font-size: 10px; font-weight: 800; color: var(--amber);
            background: rgba(245,158,11,0.15);
            padding: 2px 8px; border-radius: 50px;
        }

        .prop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 6px; margin-bottom: 16px;
        }
        .prop-btn {
            padding: 10px 4px;
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 10px; color: var(--text-dim);
            font-family: 'Cairo'; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .prop-btn:active { transform: scale(0.95); }
        .prop-btn .prop-icon { font-size: 20px; }
        .prop-btn.selected {
            background: rgba(245,158,11,0.12);
            border-color: var(--amber); color: #fbbf24;
        }

        .purpose-row {
            display: flex; gap: 8px; margin-bottom: 16px;
        }
        .purpose-btn {
            flex: 1; padding: 12px;
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 10px; color: var(--text-dim);
            font-family: 'Cairo'; font-size: 14px; font-weight: 700;
            cursor: pointer; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .purpose-btn:active { transform: scale(0.95); }
        .purpose-btn.selected {
            background: rgba(245,158,11,0.12);
            border-color: var(--amber); color: #fbbf24;
        }

        .phone-wrapper {
            display: flex; gap: 8px; margin-bottom: 16px; direction: ltr;
        }
        .phone-prefix-box {
            padding: 12px 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--glass-border);
            border-radius: 10px; color: var(--text-dim);
            font-family: 'Cairo'; font-size: 15px; font-weight: 700;
            flex-shrink: 0;
        }
        .phone-input {
            flex: 1; padding: 12px 14px;
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 10px; color: #fff;
            font-family: 'Cairo'; font-size: 16px; font-weight: 600;
            outline: none; direction: ltr; text-align: left;
        }
        .phone-input:focus {
            border-color: var(--amber);
            background: rgba(245,158,11,0.08);
        }
        .phone-input::placeholder { color: var(--text-dimmer); }

        .broker-submit {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--amber), #d97706);
            border: none; border-radius: 12px;
            color: #fff; font-family: 'Cairo'; font-size: 15px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .broker-submit:disabled { opacity: 0.35; cursor: not-allowed; }
        .broker-submit:active:not(:disabled) { transform: scale(0.97); }

        .broker-success {
            display: none; text-align: center; padding: 24px 16px;
        }
        .broker-success.show { display: block; }
        .broker-success-icon { font-size: 44px; margin-bottom: 10px; }
        .broker-success-title { font-size: 17px; font-weight: 800; color: var(--green); margin-bottom: 6px; }
        .broker-success-desc { font-size: 12px; color: var(--text-dim); line-height: 1.7; }

        /* ===== MARKER STYLES ===== */
        .custom-marker { background: none; border: none; }
        .marker-pin {
            width: 40px; height: 40px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.9);
            animation: markerDrop 0.4s ease-out;
        }
        .marker-pin .marker-icon { transform: rotate(45deg); font-size: 17px; line-height: 1; }
        @keyframes markerDrop {
            0% { transform: rotate(-45deg) translateY(-25px); opacity: 0; }
            60% { transform: rotate(-45deg) translateY(2px); }
            100% { transform: rotate(-45deg) translateY(0); opacity: 1; }
        }

        .marker-info-label {
            background: rgba(10,20,15,0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 4px 8px;
            font-family: 'Cairo'; font-size: 10px; font-weight: 700;
            white-space: nowrap; text-align: center; color: #fff;
        }
        .marker-info-km { color: var(--green-light); }
        .marker-info-time { color: var(--text-dim); font-size: 9px; }
        .marker-info-rush { color: #fca5a5; font-size: 9px; }

        .centroid-marker-inner {
            width: 20px; height: 20px;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border: 3px solid #fff; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(16,185,129,0.4);
            animation: centroidPulse 2s infinite;
        }
        @keyframes centroidPulse {
            0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.6); }
            70% { box-shadow: 0 0 0 18px rgba(16,185,129,0); }
            100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
        }

        /* ===== LEAFLET POPUP ===== */
        .leaflet-popup-content-wrapper {
            background: rgba(10,20,30,0.95); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 12px;
            color: #fff; font-family: 'Cairo';
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .leaflet-popup-tip { background: rgba(10,20,30,0.95); border: 1px solid var(--glass-border); }
        .leaflet-popup-content { margin: 12px 14px; font-size: 13px; }
        .popup-title { font-weight: 700; font-size: 14px; margin-bottom: 3px; }
        .popup-info { color: var(--text-dim); font-size: 11px; }
        .popup-remove {
            color: var(--red); cursor: pointer; font-size: 11px; font-weight: 600;
            margin-top: 5px; display: inline-block;
            font-family: 'Cairo'; background: none; border: none; padding: 0;
        }

        /* ===== SEARCH (on map) ===== */
        .search-float {
            position: fixed;
            top: 56px; left: 12px; right: 12px;
            z-index: 800;
        }
        .search-input {
            width: 100%; padding: 13px 16px 13px 42px;
            background: rgba(10,20,35,0.88);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 14px; color: #fff;
            font-family: 'Cairo'; font-size: 14px; font-weight: 600;
            outline: none; transition: all 0.3s;
        }
        [dir="rtl"] .search-input { padding: 13px 42px 13px 16px; }
        .search-input:focus {
            border-color: var(--green);
            background: rgba(10,20,35,0.95);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .search-input::placeholder { color: var(--text-dimmer); }
        .search-icon {
            position: absolute; top: 50%; transform: translateY(-50%);
            left: 14px; color: var(--text-dimmer); font-size: 16px; pointer-events: none;
        }
        [dir="rtl"] .search-icon { left: auto; right: 14px; }

        .search-results {
            position: absolute; top: calc(100% + 6px);
            left: 0; right: 0;
            background: rgba(10,20,30,0.97);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 14px; overflow: hidden;
            display: none;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
        }
        .search-results.show { display: block; }
        .search-result-item {
            padding: 12px 14px; cursor: pointer; transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            display: flex; align-items: center; gap: 8px;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:active { background: rgba(16,185,129,0.15); }
        .search-result-icon { font-size: 14px; opacity: 0.4; }
        .search-result-text { font-size: 13px; color: rgba(255,255,255,0.7); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .search-loading { padding: 14px; text-align: center; color: var(--text-dimmer); font-size: 13px; }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            top: 16px; left: 50%; transform: translateX(-50%) translateY(-20px);
            z-index: 9999;
            background: rgba(10,20,30,0.92);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            padding: 10px 20px; border-radius: 50px;
            font-family: 'Cairo'; font-size: 13px; font-weight: 600; color: #fff;
            opacity: 0; transition: all 0.3s; pointer-events: none;
            white-space: nowrap;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }




        /* ===== MAP TYPE TOGGLE ===== */
        .map-type-toggle {
            position: fixed;
            bottom: calc(24px + var(--safe-bottom));
            right: 16px;
            z-index: 700;
            display: flex;
            background: rgba(10,20,35,0.88);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            overflow: hidden;
        }
        [dir="ltr"] .map-type-toggle { right: auto; left: 16px; }
        .map-type-btn {
            padding: 8px 14px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-family: 'Cairo'; font-size: 11px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 4px;
        }
        .map-type-btn.active {
            background: rgba(16,185,129,0.2);
            color: var(--green-light);
        }
        .map-type-btn:active { transform: scale(0.95); }

        /* ===== AD SLOT ===== */
        .ad-slot {
            background: rgba(255,255,255,0.02);
            border: 1px dashed rgba(255,255,255,0.08);
            border-radius: 10px; padding: 20px;
            text-align: center; color: var(--text-dimmer);
            font-size: 11px; margin: 12px 0;
        }

        /* ===== DESKTOP ===== */
        @media (min-width: 769px) {
            .sidebar-toggle { display: none !important; }
            .sidebar-drawer {
                position: fixed; top: 0; right: 0; bottom: 0;
                width: 380px; transform: translateX(0);
                border-inline-start: 1px solid var(--glass-border);
            }
            [dir="ltr"] .sidebar-drawer { transform: translateX(0); }
            .sidebar-backdrop { display: none !important; }
            .result-fab { left: auto; right: 400px; }
            [dir="ltr"] .result-fab { right: auto; left: 400px; }
            .add-overlay { right: 400px; }
            [dir="ltr"] .add-overlay { left: 400px; right: 12px; }
            .map-hint { right: 400px; left: auto; transform: none; margin-right: 16px; }
            .search-float { right: 400px; }
            [dir="ltr"] .search-float { left: 400px; right: 12px; }
            .leaflet-control-zoom { margin-right: 10px !important; }
        }
    </style>
</head>
<body>

    <!-- MAP -->
    <div id="map"></div>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="top-brand">
            <div class="top-logo">ğŸ </div>
            <span class="top-title" data-ar="ÙˆÙŠÙ† Ø£Ø³ÙƒÙ†" data-en="Wain Askan">ÙˆÙŠÙ† Ø£Ø³ÙƒÙ†</span>
        </div>
        <div class="top-actions">
            <button class="lang-btn active" onclick="setLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
        </div>
    </div>

    <!-- SEARCH (floating on map) -->
    <div class="search-float">
        <div style="position:relative;">
            <input type="text" class="search-input" id="searchInput"
                placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­ÙŠ Ø£Ùˆ Ù…ÙƒØ§Ù†..."
                data-ar-ph="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­ÙŠ Ø£Ùˆ Ù…ÙƒØ§Ù†..."
                data-en-ph="Search neighborhood or place..."
                autocomplete="off">
            <span class="search-icon">ğŸ”</span>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- MAP HINT -->
    <div class="map-hint" id="mapHint">
        <span class="map-hint-icon">ğŸ‘†</span>
        <span data-ar="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù†" data-en="Tap on map to add a place">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù†</span>
    </div>

    <!-- MAP TYPE TOGGLE -->
    <div class="map-type-toggle" id="mapTypeToggle">
        <button class="map-type-btn active" onclick="setMapType('street')" id="mapStreetBtn">
            ğŸ—ºï¸ <span data-ar="Ø¹Ø§Ø¯ÙŠ" data-en="Street">Ø¹Ø§Ø¯ÙŠ</span>
        </button>
        <button class="map-type-btn" onclick="setMapType('satellite')" id="mapSatBtn">
            ğŸ›°ï¸ <span data-ar="Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ" data-en="Satellite">Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ</span>
        </button>
    </div>

    <!-- ADD FORM OVERLAY (appears on map click) -->
    <div class="add-overlay" id="addOverlay">
        <div class="add-overlay-header">
            <div class="add-overlay-neighborhood" id="addNeighborhood">
                <span>ğŸ“</span>
                <span id="addNeighborhoodText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
            </div>
            <button class="add-overlay-close" onclick="closeAddForm()">âœ•</button>
        </div>

        <input type="text" class="add-name-input" id="locationName"
            placeholder="Ø³Ù…Ù‘ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù†..."
            data-ar-ph="Ø³Ù…Ù‘ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù†..."
            data-en-ph="Name this place...">

        <div class="quick-row">
            <button class="quick-btn" onclick="pickQuick(this,'ğŸ¡','Ø¨ÙŠØª Ø§Ù„Ø£Ù‡Ù„','Family Home')">
                <span class="q-icon">ğŸ¡</span>
                <span data-ar="Ø¨ÙŠØª Ø§Ù„Ø£Ù‡Ù„" data-en="Family">Ø¨ÙŠØª Ø§Ù„Ø£Ù‡Ù„</span>
            </button>
            <button class="quick-btn" onclick="pickQuick(this,'ğŸ’¼','Ø§Ù„Ø¹Ù…Ù„','Work')">
                <span class="q-icon">ğŸ’¼</span>
                <span data-ar="Ø§Ù„Ø¹Ù…Ù„" data-en="Work">Ø§Ù„Ø¹Ù…Ù„</span>
            </button>
            <button class="quick-btn" onclick="pickQuick(this,'ğŸŒ´','Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©','Rest House')">
                <span class="q-icon">ğŸŒ´</span>
                <span data-ar="Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©" data-en="Rest House">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</span>
            </button>
        </div>

        <div class="freq-row">
            <button class="freq-btn selected" data-freq="daily" onclick="pickFreq(this)">
                <span data-ar="ÙŠÙˆÙ…ÙŠ ğŸ“…" data-en="Daily ğŸ“…">ÙŠÙˆÙ…ÙŠ ğŸ“…</span>
            </button>
            <button class="freq-btn" data-freq="weekly" onclick="pickFreq(this)">
                <span data-ar="Ø£Ø³Ø¨ÙˆØ¹ÙŠ ğŸ—“ï¸" data-en="Weekly ğŸ—“ï¸">Ø£Ø³Ø¨ÙˆØ¹ÙŠ ğŸ—“ï¸</span>
            </button>
        </div>

        <button class="add-confirm-btn" onclick="confirmAdd()">
            <span data-ar="Ø£Ø¶Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹" data-en="Add Location">Ø£Ø¶Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
            <span>âœ…</span>
        </button>
    </div>

    <!-- RESULT FAB -->
    <button class="result-fab" id="resultFab" onclick="calculateOptimal()">
        <span class="fab-icon">âœ¨</span>
        <span data-ar="Ø¹Ø·Ù†ÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©" data-en="Show Result">Ø¹Ø·Ù†ÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©</span>
        <span class="fab-count" id="fabCount">0</span>
    </button>

    <!-- SIDEBAR TOGGLE -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="openSidebar()">
        <span class="toggle-count" id="toggleCount">0</span>
        <span class="toggle-icon">ğŸ“‹</span>
    </button>

    <!-- SIDEBAR BACKDROP -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>

    <!-- SIDEBAR DRAWER -->
    <div class="sidebar-drawer" id="sidebarDrawer">
        <div class="sidebar-header">
            <span class="sidebar-title" data-ar="ğŸ“ Ø£Ù…Ø§ÙƒÙ†Ùƒ" data-en="ğŸ“ Your Places">ğŸ“ Ø£Ù…Ø§ÙƒÙ†Ùƒ</span>
            <button class="sidebar-close" onclick="closeSidebar()">âœ•</button>
        </div>
        <div class="sidebar-body" id="sidebarBody">
            <div class="sidebar-locations" id="sidebarLocations">
                <div class="sidebar-empty" id="sidebarEmpty">
                    <div class="sidebar-empty-icon">ğŸ“</div>
                    <p data-ar="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø§ÙƒÙ†Ùƒ" data-en="Tap the map to add your places">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø§ÙƒÙ†Ùƒ</p>
                </div>
            </div>
            <div class="ad-slot" style="margin-top:20px;">
                <div>Ø¥Ø¹Ù„Ø§Ù† - Ad</div>
            </div>
        </div>
        <button class="sidebar-calc-btn" id="sidebarCalcBtn" onclick="calculateOptimal()" disabled>
            <span>âœ¨</span>
            <span data-ar="Ø¹Ø·Ù†ÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©" data-en="Show Result">Ø¹Ø·Ù†ÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©</span>
        </button>
    </div>

    <!-- RESULT OVERLAY -->
    <div class="result-overlay" id="resultOverlay" onclick="if(event.target===this)closeResult()">
        <div class="result-sheet" id="resultSheet">
            <div class="result-sheet-handle"></div>
            <div class="result-sheet-body">
                <div class="result-badge">
                    <span>ğŸ¯</span>
                    <span data-ar="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©" data-en="Optimal Area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©</span>
                </div>
                <div class="result-neighborhood" id="resultNeighborhood">---</div>
                <div class="result-desc" id="resultDesc"></div>
                <div class="result-justification" id="resultJustification"></div>
                <div class="result-distances" id="resultDistances"></div>

                <div class="result-actions">
                    <button class="result-btn" onclick="resetAll()">
                        <span data-ar="ğŸ”„ Ù…Ù† Ø¬Ø¯ÙŠØ¯" data-en="ğŸ”„ Reset">ğŸ”„ Ù…Ù† Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                    <button class="result-btn" onclick="shareResult()">
                        <span data-ar="ğŸ“‹ Ù†Ø³Ø®" data-en="ğŸ“‹ Copy">ğŸ“‹ Ù†Ø³Ø®</span>
                    </button>
                </div>

                <div class="ad-slot"><div>Ø¥Ø¹Ù„Ø§Ù† - Ad</div></div>

                <!-- BROKER -->
                <div class="broker-divider"></div>
                <div id="brokerArea">
                    <div class="broker-title" data-ar="ğŸ¡ ØªØ¨ÙŠ ÙˆØ³ÙŠØ· Ø¹Ù‚Ø§Ø±ÙŠØŸ" data-en="ğŸ¡ Want a broker?">ğŸ¡ ØªØ¨ÙŠ ÙˆØ³ÙŠØ· Ø¹Ù‚Ø§Ø±ÙŠØŸ</div>
                    <div class="broker-desc" data-ar="Ø³Ø¬Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ¨ÙŠØªÙˆØ§ØµÙ„ÙˆÙ† Ù…Ø¹Ùƒ" data-en="Register and brokers will contact you">Ø³Ø¬Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ¨ÙŠØªÙˆØ§ØµÙ„ÙˆÙ† Ù…Ø¹Ùƒ</div>

                    <div class="broker-q-label">
                        <span class="broker-q-num">1</span>
                        <span data-ar="ÙˆØ´ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ" data-en="Property type?">ÙˆØ´ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ</span>
                    </div>
                    <div class="prop-grid" id="propGrid">
                        <button class="prop-btn" data-type="land" onclick="pickProp(this)">
                            <span class="prop-icon">ğŸ—ï¸</span><span data-ar="Ø£Ø±Ø¶" data-en="Land">Ø£Ø±Ø¶</span>
                        </button>
                        <button class="prop-btn" data-type="villa" onclick="pickProp(this)">
                            <span class="prop-icon">ğŸ¡</span><span data-ar="ÙÙŠÙ„Ø§" data-en="Villa">ÙÙŠÙ„Ø§</span>
                        </button>
                        <button class="prop-btn" data-type="apartment" onclick="pickProp(this)">
                            <span class="prop-icon">ğŸ¢</span><span data-ar="Ø´Ù‚Ø©" data-en="Apt">Ø´Ù‚Ø©</span>
                        </button>
                        <button class="prop-btn" data-type="duplex" onclick="pickProp(this)">
                            <span class="prop-icon">ğŸ˜ï¸</span><span data-ar="Ø¯Ø¨Ù„ÙƒØ³" data-en="Duplex">Ø¯Ø¨Ù„ÙƒØ³</span>
                        </button>
                        <button class="prop-btn" data-type="floor" onclick="pickProp(this)">
                            <span class="prop-icon">ğŸ </span><span data-ar="Ø¯ÙˆØ±" data-en="Floor">Ø¯ÙˆØ±</span>
                        </button>
                        <button class="prop-btn" data-type="townhouse" onclick="pickProp(this)">
                            <span class="prop-icon">ğŸšï¸</span><span data-ar="ØªØ§ÙˆÙ† Ù‡Ø§ÙˆØ³" data-en="Town H.">ØªØ§ÙˆÙ† Ù‡Ø§ÙˆØ³</span>
                        </button>
                    </div>

                    <div class="broker-q-label">
                        <span class="broker-q-num">2</span>
                        <span data-ar="Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø¥ÙŠØ¬Ø§Ø±ØŸ" data-en="Buy or Rent?">Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø¥ÙŠØ¬Ø§Ø±ØŸ</span>
                    </div>
                    <div class="purpose-row" id="purposeRow">
                        <button class="purpose-btn" data-purpose="buy" onclick="pickPurpose(this)">
                            <span>ğŸ”‘</span><span data-ar="Ø´Ø±Ø§Ø¡" data-en="Buy">Ø´Ø±Ø§Ø¡</span>
                        </button>
                        <button class="purpose-btn" data-purpose="rent" onclick="pickPurpose(this)">
                            <span>ğŸ“</span><span data-ar="Ø¥ÙŠØ¬Ø§Ø±" data-en="Rent">Ø¥ÙŠØ¬Ø§Ø±</span>
                        </button>
                    </div>

                    <div class="broker-q-label">
                        <span class="broker-q-num">3</span>
                        <span data-ar="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" data-en="Phone number">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
                    </div>
                    <div class="phone-wrapper">
                        <span class="phone-prefix-box">+966</span>
                        <input type="tel" class="phone-input" id="brokerPhone"
                            placeholder="5XXXXXXXX"
                            maxlength="9"
                            oninput="onPhoneInput(this)">
                    </div>

                    <button class="broker-submit" id="brokerSubmitBtn" onclick="submitBroker()" disabled>
                        <span>ğŸ“¤</span>
                        <span data-ar="Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ÙŠ" data-en="Send Request">Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ÙŠ</span>
                    </button>
                </div>

                <div class="broker-success" id="brokerSuccess">
                    <div class="broker-success-icon">ğŸ‰</div>
                    <div class="broker-success-title" data-ar="ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ!" data-en="Request sent!">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ!</div>
                    <div class="broker-success-desc" data-ar="ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ÙˆÙŠÙ† Ø£Ø³ÙƒÙ†!" data-en="Your request has been registered. Thanks for using Wain Askan!">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ÙˆÙŠÙ† Ø£Ø³ÙƒÙ†!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== STATE =====
        let lang = 'ar';
        let locations = [];
        let pendingLocation = null;
        let isCalculated = false;
        let selectedEmoji = 'ğŸ“Œ';
        let selectedFreq = 'daily';

        let map, markersGroup;
        let streetLayer, satelliteLayer, currentMapType = 'street';
        let centroidMarker = null, zoneRect = null;
        let connectionLines = [], distanceLabels = [];
        let tempMarker = null;

        const LOCATION_COLORS = ['#10b981','#f59e0b','#3b82f6','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
        const FREQ_WEIGHTS = { daily: 30, weekly: 4 };
        // Ø§Ù„Ø¹Ù…Ù„ ÙŠÙˆÙ…ÙŠ = 5 Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ = 22 ÙŠÙˆÙ… Ø¨Ø§Ù„Ø´Ù‡Ø±
        function getWeight(loc) {
            const isWork = loc.name === 'Ø§Ù„Ø¹Ù…Ù„' || loc.name === 'Work' || loc.name === 'Ø§Ù„Ù…ÙƒØªØ¨' || loc.name === 'Office';
            if (isWork && loc.frequency === 'daily') return 22; // 5 days/week
            return FREQ_WEIGHTS[loc.frequency];
        }
        function hasWorkLocation() {
            return locations.some(l => (l.name === 'Ø§Ù„Ø¹Ù…Ù„' || l.name === 'Work' || l.name === 'Ø§Ù„Ù…ÙƒØªØ¨' || l.name === 'Office') && l.frequency === 'daily');
        }
        const FREQ_LABELS = {
            daily:  { ar: 'ÙŠÙˆÙ…ÙŠ',    en: 'Daily' },
            weekly: { ar: 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ', en: 'Weekly' }
        };
        const AVG_SPEED_NORMAL = 45;
        const AVG_SPEED_RUSH   = 22;

        let brokerData = { propertyType: null, purpose: null };

        // ===== ARABIC TO ENGLISH DIGITS =====
        function toEnglishDigits(str) {
            const arabicMap = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
            return str.replace(/[Ù -Ù©]/g, d => arabicMap[d]);
        }

        function onPhoneInput(el) {
            // Convert Arabic digits to English immediately
            el.value = toEnglishDigits(el.value).replace(/[^0-9]/g, '');
            checkBrokerValid();
        }

        // ===== HELPERS =====
        function estimateMinutes(km, speed) { return Math.max(1, Math.round((km / speed) * 60)); }

        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML.replace(/'/g, "\\'");
        }

        // ===== MAP INIT =====
        function initMap() {
            map = L.map('map', {
                center: [24.7136, 46.6753],
                zoom: 11,
                zoomControl: true,
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: true,
                doubleClickZoom: false,
                boxZoom: true,
                keyboard: true
            });

            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            });

            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri',
                maxZoom: 19
            });

            streetLayer.addTo(map);

            markersGroup = L.layerGroup().addTo(map);

            map.on('click', function(e) {
                if (isCalculated) return;
                onMapClick(e.latlng.lat, e.latlng.lng);
            });

            setTimeout(() => map.invalidateSize(), 100);
        }

        // ===== MAP CLICK =====
        function onMapClick(lat, lng) {
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }

            tempMarker = L.circleMarker([lat, lng], {
                radius: 12, color: '#10b981', fillColor: '#10b981',
                fillOpacity: 0.3, weight: 2
            }).addTo(map);

            document.getElementById('mapHint').classList.add('hidden');

            pendingLocation = { lat, lng };
            selectedEmoji = 'ğŸ“Œ';
            selectedFreq = 'daily';

            // Reset quick buttons
            document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector('.freq-btn[data-freq="daily"]').classList.add('selected');
            document.getElementById('locationName').value = '';

            // Reverse geocode
            document.getElementById('addNeighborhoodText').textContent = lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...' : 'Detecting...';
            reverseGeocode(lat, lng).then(name => {
                document.getElementById('addNeighborhoodText').textContent = name;
            });

            // Show form
            document.getElementById('addOverlay').classList.add('show');
            setTimeout(() => document.getElementById('locationName').focus(), 350);
        }

        // ===== SEARCH =====
        let searchTimeout = null;
        document.addEventListener('DOMContentLoaded', function() {
            const si = document.getElementById('searchInput');
            si.addEventListener('input', function() {
                const q = this.value.trim();
                const r = document.getElementById('searchResults');
                if (q.length < 2) { r.classList.remove('show'); return; }
                clearTimeout(searchTimeout);
                r.innerHTML = `<div class="search-loading">${lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...' : 'Searching...'}</div>`;
                r.classList.add('show');
                searchTimeout = setTimeout(() => searchNominatim(q), 400);
            });
            si.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) document.getElementById('searchResults').classList.add('show');
            });
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-float')) document.getElementById('searchResults').classList.remove('show');
            });
        });

        async function searchNominatim(query) {
            const r = document.getElementById('searchResults');
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ' Ø§Ù„Ø±ÙŠØ§Ø¶')}&format=json&addressdetails=1&limit=5&viewbox=46.2,25.1,47.2,24.3&bounded=1&accept-language=${lang}`;
                const res = await fetch(url, { headers: { 'User-Agent': 'WainAskan/1.0' } });
                const data = await res.json();
                if (!data.length) { r.innerHTML = `<div class="search-loading">${lang === 'ar' ? 'Ù„Ø§ Ù†ØªØ§Ø¦Ø¬' : 'No results'}</div>`; return; }
                r.innerHTML = data.map(i => `
                    <div class="search-result-item" onclick="selectSearch(${i.lat},${i.lon},'${escapeHtml(i.display_name)}')">
                        <span class="search-result-icon">ğŸ“</span>
                        <span class="search-result-text">${i.display_name}</span>
                    </div>`).join('');
            } catch { r.innerHTML = `<div class="search-loading">${lang === 'ar' ? 'Ø®Ø·Ø£' : 'Error'}</div>`; }
        }

        function selectSearch(lat, lng) {
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('searchInput').value = '';
            map.flyTo([lat, lng], 14, { duration: 1 });
            setTimeout(() => onMapClick(lat, lng), 300);
        }

        // ===== REVERSE GEOCODE =====
        let lastGeoTime = 0;
        async function reverseGeocode(lat, lng) {
            const now = Date.now();
            const wait = Math.max(0, 1100 - (now - lastGeoTime));
            if (wait > 0) await new Promise(r => setTimeout(r, wait));
            lastGeoTime = Date.now();
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=${lang}`;
                const res = await fetch(url, { headers: { 'User-Agent': 'WainAskan/1.0' } });
                const d = await res.json();
                if (d.address) return d.address.suburb || d.address.neighbourhood || d.address.city_district || d.address.road || d.display_name.split(',')[0];
                return lang === 'ar' ? 'Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯' : 'Location';
            } catch { return lang === 'ar' ? 'Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯' : 'Location'; }
        }

        // ===== ADD FORM CONTROLS =====
        function pickQuick(el, emoji, arName, enName) {
            document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('locationName').value = lang === 'ar' ? arName : enName;
            selectedEmoji = emoji;
        }

        function pickFreq(el) {
            document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedFreq = el.dataset.freq;
        }

        function closeAddForm() {
            document.getElementById('addOverlay').classList.remove('show');
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
            pendingLocation = null;
        }

        function confirmAdd() {
            if (!pendingLocation) return;

            const nameInput = document.getElementById('locationName').value.trim();
            const name = nameInput || (lang === 'ar' ? 'Ù…ÙƒØ§Ù†' : 'Place');
            const neighborhood = document.getElementById('addNeighborhoodText').textContent;

            const NAME_ICONS = { 'Ø§Ù„Ø¹Ù…Ù„':'ğŸ’¼','Work':'ğŸ’¼','Ø¨ÙŠØª Ø§Ù„Ø£Ù‡Ù„':'ğŸ¡','Family Home':'ğŸ¡','Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©':'ğŸŒ´','Rest House':'ğŸŒ´',
                'Ø§Ù„Ù…Ù†Ø²Ù„':'ğŸ ','Home':'ğŸ ','Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©':'ğŸ“','University':'ğŸ“','Ø§Ù„Ù†Ø§Ø¯ÙŠ':'ğŸ‹ï¸','Gym':'ğŸ‹ï¸',
                'Ø§Ù„Ù…ÙƒØªØ¨':'ğŸ¢','Office':'ğŸ¢','Ø§Ù„Ø³ÙˆÙ‚':'ğŸ›’','Market':'ğŸ›’','Ø§Ù„Ù…Ø¯Ø±Ø³Ø©':'ğŸ«','School':'ğŸ«','Ø§Ù„Ù…Ø³Ø¬Ø¯':'ğŸ•Œ','Mosque':'ğŸ•Œ' };

            let icon = selectedEmoji;
            if (NAME_ICONS[name]) icon = NAME_ICONS[name];

            const color = LOCATION_COLORS[locations.length % LOCATION_COLORS.length];

            const loc = {
                id: 'loc_' + Date.now(),
                name, neighborhood, icon,
                lat: pendingLocation.lat,
                lng: pendingLocation.lng,
                frequency: selectedFreq,
                color, marker: null
            };

            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-pin" style="background:${color}"><span class="marker-icon">${icon}</span></div>`,
                iconSize: [40, 46], iconAnchor: [20, 46], popupAnchor: [0, -46]
            });

            const marker = L.marker([loc.lat, loc.lng], { icon: markerIcon }).addTo(markersGroup);
            marker.bindPopup(createPopup(loc));
            loc.marker = marker;

            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }

            locations.push(loc);
            closeAddForm();
            updateUI();

            showToast(lang === 'ar' ? `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${name}" âœ…` : `"${name}" added âœ…`);
        }

        function createPopup(loc) {
            const freq = lang === 'ar' ? FREQ_LABELS[loc.frequency].ar : FREQ_LABELS[loc.frequency].en;
            return `<div class="popup-title">${loc.icon} ${loc.name}</div>
                <div class="popup-info">${loc.neighborhood} Â· ${freq}</div>
                <button class="popup-remove" onclick="removeLoc('${loc.id}')">${lang === 'ar' ? 'ğŸ—‘ï¸ Ø­Ø°Ù' : 'ğŸ—‘ï¸ Remove'}</button>`;
        }

        function removeLoc(id) {
            const idx = locations.findIndex(l => l.id === id);
            if (idx === -1) return;
            if (locations[idx].marker) markersGroup.removeLayer(locations[idx].marker);
            locations.splice(idx, 1);
            map.closePopup();
            if (isCalculated) clearResult();
            updateUI();
            showToast(lang === 'ar' ? 'ØªÙ… Ø§Ù„Ø­Ø°Ù' : 'Removed');
        }

        // ===== UPDATE UI =====
        function updateUI() {
            const count = locations.length;

            // FAB button
            const fab = document.getElementById('resultFab');
            if (count >= 1 && !isCalculated) {
                fab.classList.add('show');
                document.getElementById('fabCount').textContent = count;
            } else {
                fab.classList.remove('show');
            }

            // Sidebar toggle
            const toggle = document.getElementById('sidebarToggle');
            if (count > 0) {
                toggle.classList.add('show');
                document.getElementById('toggleCount').textContent = count;
            } else {
                toggle.classList.remove('show');
            }

            // Sidebar content
            renderSidebarLocations();

            // Sidebar calc button
            document.getElementById('sidebarCalcBtn').disabled = count < 1 || isCalculated;

            // Hide hint
            if (count > 0) document.getElementById('mapHint').classList.add('hidden');
        }

        function renderSidebarLocations() {
            const container = document.getElementById('sidebarLocations');
            const empty = document.getElementById('sidebarEmpty');

            if (locations.length === 0) {
                container.innerHTML = '';
                container.appendChild(empty);
                empty.style.display = '';
                return;
            }

            empty.style.display = 'none';
            const cards = locations.map(loc => {
                const freq = lang === 'ar' ? FREQ_LABELS[loc.frequency].ar : FREQ_LABELS[loc.frequency].en;
                return `<div class="sidebar-loc-card">
                    <div class="sloc-icon" style="background:${loc.color}20;color:${loc.color}">${loc.icon}</div>
                    <div class="sloc-info">
                        <div class="sloc-name">${loc.name}</div>
                        <div class="sloc-meta">
                            <span class="sloc-freq-badge" style="background:${loc.color}20;color:${loc.color}">${freq}</span>
                            Â· ${loc.neighborhood}
                        </div>
                    </div>
                    <button class="sloc-delete" onclick="removeLoc('${loc.id}')">âœ•</button>
                </div>`;
            }).join('');

            container.innerHTML = cards + `<div id="sidebarEmpty" class="sidebar-empty" style="display:none">
                <div class="sidebar-empty-icon">ğŸ“</div>
                <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</p>
            </div>`;
        }

        // ===== SIDEBAR =====
        function openSidebar() {
            document.getElementById('sidebarDrawer').classList.add('show');
            document.getElementById('sidebarBackdrop').classList.add('show');
        }
        function closeSidebar() {
            document.getElementById('sidebarDrawer').classList.remove('show');
            document.getElementById('sidebarBackdrop').classList.remove('show');
        }

        // ===== CALCULATE =====
        async function calculateOptimal() {
            if (locations.length < 1) return;
            closeSidebar();

            // Weighted centroid
            let totalW = 0, wLat = 0, wLng = 0;
            locations.forEach(loc => {
                const w = getWeight(loc);
                wLat += loc.lat * w; wLng += loc.lng * w; totalW += w;
            });
            const cLat = wLat / totalW, cLng = wLng / totalW;

            clearMapOverlays();

            // Centroid marker
            centroidMarker = L.marker([cLat, cLng], {
                icon: L.divIcon({ className: 'custom-marker', html: '<div class="centroid-marker-inner"></div>', iconSize: [20, 20], iconAnchor: [10, 10] }),
                zIndexOffset: 1000
            }).addTo(map);

            // 1km zone
            const latOff = 0.5 / 111.32;
            const lngOff = 0.5 / (111.32 * Math.cos(cLat * Math.PI / 180));
            zoneRect = L.rectangle([[cLat - latOff, cLng - lngOff], [cLat + latOff, cLng + lngOff]], {
                color: '#10b981', weight: 2, fillColor: '#10b981', fillOpacity: 0.1, dashArray: '8,6'
            }).addTo(map);

            // Distances
            const distData = locations.map(loc => {
                const dist = haversineDistance(cLat, cLng, loc.lat, loc.lng);
                return { loc, dist, normalMin: estimateMinutes(dist, AVG_SPEED_NORMAL), rushMin: estimateMinutes(dist, AVG_SPEED_RUSH) };
            });

            // Lines + labels
            distData.forEach(({ loc, dist, normalMin, rushMin }) => {
                const line = L.polyline([[cLat, cLng], [loc.lat, loc.lng]], { color: loc.color, weight: 2, dashArray: '6,8', opacity: 0.5 }).addTo(map);
                connectionLines.push(line);

                const dText = lang === 'ar' ? 'Ø¯' : 'min';
                const lbl = L.marker([loc.lat + (loc.lat - cLat) * 0.12, loc.lng + (loc.lng - cLng) * 0.12], {
                    icon: L.divIcon({
                        className: '',
                        html: `<div class="marker-info-label"><div class="marker-info-km">${dist.toFixed(1)} km</div><div class="marker-info-time">ğŸŸ¢ ${normalMin} ${dText}</div><div class="marker-info-rush">ğŸ”´ ${rushMin} ${dText}</div></div>`,
                        iconSize: [90, 40], iconAnchor: [45, 20]
                    }), interactive: false
                }).addTo(map);
                distanceLabels.push(lbl);
            });

            // Fly to bounds
            const bounds = L.latLngBounds(locations.map(l => [l.lat, l.lng]));
            bounds.extend([cLat, cLng]);
            map.flyToBounds(bounds.pad(0.2), { duration: 1 });

            // Get neighborhood
            const neighborhood = await reverseGeocode(cLat, cLng);

            // Populate result
            document.getElementById('resultNeighborhood').textContent = neighborhood;

            const avgDist = distData.reduce((s, d) => s + d.dist, 0) / distData.length;
            const avgN = Math.round(distData.reduce((s, d) => s + d.normalMin, 0) / distData.length);
            const avgR = Math.round(distData.reduce((s, d) => s + d.rushMin, 0) / distData.length);

            document.getElementById('resultDesc').textContent = lang === 'ar'
                ? `Ù…ØªÙˆØ³Ø·: ${avgDist.toFixed(1)} ÙƒÙ… Â· Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ ~${avgN} Ø¯ Â· ÙˆÙ‚Øª Ø§Ù„Ø°Ø±ÙˆØ© ~${avgR} Ø¯`
                : `Avg: ${avgDist.toFixed(1)} km Â· Normal ~${avgN} min Â· Rush hour ~${avgR} min`;

            buildJustification(distData, cLat, cLng, neighborhood);

            // Distance list
            const dLabel = lang === 'ar' ? 'Ø¯' : 'min';
            const nLabel = lang === 'ar' ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ' : 'Normal';
            const rLabel = lang === 'ar' ? 'ÙˆÙ‚Øª Ø§Ù„Ø°Ø±ÙˆØ©' : 'Rush hour';
            document.getElementById('resultDistances').innerHTML = distData.map(({ loc, dist, normalMin, rushMin }) => `
                <div class="rdist-item">
                    <div class="rdist-header">
                        <div class="rdist-name"><span>${loc.icon}</span><span>${loc.name}</span></div>
                        <span class="rdist-km">${dist.toFixed(1)} km</span>
                    </div>
                    <div class="rdist-times">
                        <span class="rdist-time rdist-normal">ğŸŸ¢ ${nLabel}: ${normalMin} ${dLabel}</span>
                        <span class="rdist-time rdist-rush">ğŸ”´ ${rLabel}: ${rushMin} ${dLabel}</span>
                    </div>
                </div>`).join('');

            isCalculated = true;
            updateUI();

            // Reset broker
            brokerData = { propertyType: null, purpose: null };
            document.querySelectorAll('.prop-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.purpose-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('brokerPhone').value = '';
            document.getElementById('brokerSubmitBtn').disabled = true;
            document.getElementById('brokerArea').style.display = '';
            document.getElementById('brokerSuccess').classList.remove('show');

            // Show result
            document.getElementById('resultOverlay').classList.add('show');

            showToast(lang === 'ar' ? 'ğŸ¯ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©!' : 'ğŸ¯ Optimal area found!');
        }

        // ===== JUSTIFICATION (5 concise points) =====
        function buildJustification(distData, cLat, cLng, neighborhood) {
            const el = document.getElementById('resultJustification');
            const sorted = [...distData].sort((a, b) => getWeight(b.loc) - getWeight(a.loc));
            const most = sorted[0];

            const totalTrips = distData.reduce((s, d) => s + getWeight(d.loc), 0);
            const totalKm = distData.reduce((s, d) => s + d.dist * getWeight(d.loc) * 2, 0);
            const totalNormalMin = Math.round(distData.reduce((s, d) => s + d.normalMin * getWeight(d.loc) * 2, 0));
            const totalRushMin = Math.round(distData.reduce((s, d) => s + d.rushMin * getWeight(d.loc) * 2, 0));

            // Fuel: 2.25 SAR/liter, avg 12km/liter
            const monthlyFuel = Math.round((totalKm / 12) * 2.25);

            const workNote = hasWorkLocation();

            let pts;
            if (lang === 'ar') {
                pts = [
                    `ğŸ“ <strong>Ø§Ù„Ø£Ù…Ø«Ù„:</strong> Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ù…ØªÙˆØ§Ø²Ù†Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø£Ù…Ø§ÙƒÙ†Ùƒ.`,
                    `â±ï¸ <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> Ù…Ø¬Ù…ÙˆØ¹ ØªÙ†Ù‚Ù„Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ ~${totalNormalMin} Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ø§Ø¯ÙŠØŒ ~${totalRushMin} Ø¯Ù‚ÙŠÙ‚Ø© Ø°Ø±ÙˆØ©.`,
                    `ğŸ“ <strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ~${Math.round(totalKm)} ÙƒÙ… (Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø©).`,
                    `â›½ <strong>Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†:</strong> ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ~${monthlyFuel} Ø±ÙŠØ§Ù„ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹.`,
                    `âœ… <strong>Ø§Ù„Ø®Ù„Ø§ØµØ©:</strong> ${neighborhood} Ø£ÙØ¶Ù„ Ø­ÙŠ ÙŠÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø£Ù…Ø§ÙƒÙ†Ùƒ ÙˆÙŠÙˆÙØ± Ù„Ùƒ ÙˆÙ‚Øª ÙˆØ¨Ù†Ø²ÙŠÙ† ÙƒÙ„ Ø´Ù‡Ø±.`
                ];
            } else {
                pts = [
                    `ğŸ“ <strong>Optimal:</strong> Best balanced point for all your places.`,
                    `â±ï¸ <strong>Time:</strong> Total monthly commute ~${totalNormalMin} min normal, ~${totalRushMin} min rush.`,
                    `ğŸ“ <strong>Distance:</strong> Total monthly distance ~${Math.round(totalKm)} km (round-trip).`,
                    `â›½ <strong>Fuel:</strong> Estimated monthly fuel cost ~${monthlyFuel} SAR.`,
                    `âœ… <strong>Conclusion:</strong> ${neighborhood} best balances all your places, saving you time and fuel monthly.`
                ];
            }

            let noteHtml = '';
            if (workNote) {
                noteHtml = `<div style="font-size:10px;color:var(--text-dimmer);margin-top:8px;text-align:center;">
                    ${lang === 'ar' ? '* ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¯ÙˆØ§Ù… Ù¥ Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' : '* Work calculated as 5 days/week'}
                </div>`;
            }

            el.innerHTML = `<div class="just-title">${lang === 'ar' ? 'ğŸ’¡ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠØŸ' : 'ğŸ’¡ Why this area?'}</div>
                ${pts.map(p => `<div class="just-point"><span>â–¸</span><span>${p}</span></div>`).join('')}${noteHtml}`;
        }

        // ===== CLEAR / RESET =====
        function clearMapOverlays() {
            if (centroidMarker) { map.removeLayer(centroidMarker); centroidMarker = null; }
            if (zoneRect) { map.removeLayer(zoneRect); zoneRect = null; }
            connectionLines.forEach(l => map.removeLayer(l)); connectionLines = [];
            distanceLabels.forEach(l => map.removeLayer(l)); distanceLabels = [];
        }

        function closeResult() {
            document.getElementById('resultOverlay').classList.remove('show');
        }

        function clearResult() {
            clearMapOverlays();
            document.getElementById('resultOverlay').classList.remove('show');
            isCalculated = false;
            updateUI();
        }

        function resetAll() {
            clearResult();
            locations.forEach(l => { if (l.marker) markersGroup.removeLayer(l.marker); });
            locations = [];
            updateUI();
            document.getElementById('mapHint').classList.remove('hidden');
            map.flyTo([24.7136, 46.6753], 11, { duration: 1 });
            showToast(lang === 'ar' ? 'ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·' : 'ğŸ”„ Reset');
        }

        // ===== SHARE =====
        function shareResult() {
            const nb = document.getElementById('resultNeighborhood').textContent;
            let totalW = 0, wLat = 0, wLng = 0;
            locations.forEach(l => { const w = getWeight(l); wLat += l.lat*w; wLng += l.lng*w; totalW += w; });
            const cLat = wLat/totalW, cLng = wLng/totalW;

            const lines = locations.map(l => {
                const d = haversineDistance(cLat, cLng, l.lat, l.lng);
                const n = estimateMinutes(d, AVG_SPEED_NORMAL);
                const r = estimateMinutes(d, AVG_SPEED_RUSH);
                return lang === 'ar'
                    ? `${l.icon} ${l.name}: ${d.toFixed(1)} ÙƒÙ… (~${n} Ø¯ / ~${r} Ø¯ Ø°Ø±ÙˆØ©)`
                    : `${l.icon} ${l.name}: ${d.toFixed(1)} km (~${n}/${r} min)`;
            }).join('\n');

            const text = lang === 'ar'
                ? `ğŸ  ÙˆÙŠÙ† Ø£Ø³ÙƒÙ†ØŸ\nØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©: ${nb}\n\n${lines}\n\nğŸ“ weeenaskn.com`
                : `ğŸ  Where to Live?\nOptimal: ${nb}\n\n${lines}\n\nğŸ“ weeenaskn.com`;

            navigator.clipboard.writeText(text).then(() => showToast(lang === 'ar' ? 'ğŸ“‹ ØªÙ… Ø§Ù„Ù†Ø³Ø®!' : 'ğŸ“‹ Copied!'))
                .catch(() => showToast('âš ï¸'));
        }

        // ===== BROKER =====
        function pickProp(el) {
            document.querySelectorAll('.prop-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.propertyType = el.dataset.type;
            checkBrokerValid();
        }
        function pickPurpose(el) {
            document.querySelectorAll('.purpose-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.purpose = el.dataset.purpose;
            checkBrokerValid();
        }
        function checkBrokerValid() {
            const phone = document.getElementById('brokerPhone').value.trim();
            const valid = brokerData.propertyType && brokerData.purpose && phone.length >= 9 && phone.startsWith('5');
            document.getElementById('brokerSubmitBtn').disabled = !valid;
        }

        const GOOGLE_SHEETS_URL = '';

        function submitBroker() {
            const phone = document.getElementById('brokerPhone').value.trim();
            const neighborhood = document.getElementById('resultNeighborhood').textContent;

            const data = {
                id: 'req_' + Date.now(),
                neighborhood,
                propertyType: brokerData.propertyType,
                purpose: brokerData.purpose,
                budget: '', rooms: '', family: '', timeline: '', notes: '',
                phone: '+966' + phone,
                status: 'new',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('ar-SA'),
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
            };

            // Save locally
            try {
                const leads = JSON.parse(localStorage.getItem('wainaskan_leads') || '[]');
                leads.unshift(data);
                localStorage.setItem('wainaskan_leads', JSON.stringify(leads));
            } catch (e) { console.error(e); }

            // Google Sheets
            if (GOOGLE_SHEETS_URL) {
                fetch(GOOGLE_SHEETS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).catch(() => {});
            }

            document.getElementById('brokerArea').style.display = 'none';
            document.getElementById('brokerSuccess').classList.add('show');
            showToast(lang === 'ar' ? 'ğŸ‰ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ!' : 'ğŸ‰ Sent!');
        }

        // ===== LANGUAGE =====
        function setLang(newLang) {
            lang = newLang;
            document.documentElement.lang = newLang;
            document.documentElement.dir = newLang === 'ar' ? 'rtl' : 'ltr';

            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.lang-btn')[newLang === 'ar' ? 0 : 1].classList.add('active');

            document.querySelectorAll('[data-ar]').forEach(el => {
                el.textContent = newLang === 'ar' ? el.dataset.ar : el.dataset.en;
            });
            document.querySelectorAll('[data-ar-ph]').forEach(el => {
                el.placeholder = newLang === 'ar' ? el.dataset.arPh : el.dataset.enPh;
            });

            renderSidebarLocations();
            locations.forEach(l => { if (l.marker) l.marker.setPopupContent(createPopup(l)); });
            setTimeout(() => map.invalidateSize(), 100);
        }

        // ===== TOAST =====
        let toastTimer;
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
        }




        // ===== MAP TYPE =====
        function setMapType(type) {
            if (type === currentMapType) return;
            currentMapType = type;

            if (type === 'satellite') {
                map.removeLayer(streetLayer);
                satelliteLayer.addTo(map);
                document.getElementById('mapStreetBtn').classList.remove('active');
                document.getElementById('mapSatBtn').classList.add('active');
            } else {
                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
                document.getElementById('mapSatBtn').classList.remove('active');
                document.getElementById('mapStreetBtn').classList.add('active');
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
