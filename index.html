<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ - ÿßŸÉÿ™ÿ¥ŸÅ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂</title>
    <meta name="description" content="ÿ£ÿØÿßÿ© ÿ∞ŸÉŸäÿ© ÿ™ÿ≥ÿßÿπÿØŸÉ ÿπŸÑŸâ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ£ŸÖÿßŸÉŸÜŸÉ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©. ÿ≠ÿØÿØ ŸÖŸÉÿßŸÜ ÿπŸÖŸÑŸÉ Ÿàÿ®Ÿäÿ™ ÿ£ŸáŸÑŸÉ Ÿàÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ™ŸÉ ŸàŸÜÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸàŸÇÿπ!">
    <meta name="keywords" content="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ, ÿ≥ŸÉŸÜ ÿßŸÑÿ±Ÿäÿßÿ∂, ÿ£ŸÅÿ∂ŸÑ ÿ≠Ÿä ŸÑŸÑÿ≥ŸÉŸÜ, ÿπŸÇÿßÿ±ÿßÿ™ ÿßŸÑÿ±Ÿäÿßÿ∂, ÿ¥ŸÇŸÇ ÿßŸÑÿ±Ÿäÿßÿ∂, ŸÅŸÑŸÑ ÿßŸÑÿ±Ÿäÿßÿ∂, ÿ®ŸäŸàÿ™ ÿßŸÑÿ±Ÿäÿßÿ∂, ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ">
    <meta name="author" content="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ - ÿßŸÉÿ™ÿ¥ŸÅ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂">
    <meta property="og:description" content="ÿ£ÿØÿßÿ© ÿ∞ŸÉŸäÿ© ÿ™ÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ£ŸÖÿßŸÉŸÜŸÉ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ - ÿßŸÉÿ™ÿ¥ŸÅ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂">
    <meta name="twitter:description" content="ÿ≠ÿØÿØ ÿ£ŸÖÿßŸÉŸÜŸÉ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ© ŸàŸÜÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸàŸÇÿπ ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂">
    <link rel="canonical" href="https://wainaskan.sa/">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0a1628, #132a13, #1a2332);
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }

        /* ===== NAV ===== */
        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            z-index: 1000;
            position: relative;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-logo {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-title {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981, #6ee7b7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lang-btn {
            padding: 6px 16px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: transparent;
            color: #fff;
        }

        /* ===== APP LAYOUT ===== */
        .app-layout {
            display: flex;
            height: calc(100vh - 62px);
        }

        [dir="rtl"] .app-layout {
            flex-direction: row;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 400px;
            min-width: 400px;
            overflow-y: auto;
            padding: 24px;
            background: rgba(255,255,255,0.02);
            border-inline-start: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 2;
        }

        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        .sidebar-header h2 {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            line-height: 1.6;
        }

        /* ===== SEARCH ===== */
        .search-container { position: relative; }

        .search-input {
            width: 100%;
            padding: 14px 48px 14px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        [dir="rtl"] .search-input { padding: 14px 16px 14px 48px; }
        .search-input::placeholder { color: rgba(255,255,255,0.3); }

        .search-input:focus {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.08);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .search-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.3);
            font-size: 18px;
            pointer-events: none;
        }

        [dir="rtl"] .search-icon { left: 16px; }
        [dir="ltr"] .search-icon { right: 16px; }

        .search-results {
            position: absolute;
            top: calc(100% + 6px);
            left: 0; right: 0;
            background: rgba(15, 25, 20, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            overflow: hidden;
            z-index: 100;
            display: none;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }

        .search-results.show { display: block; }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(16, 185, 129, 0.15); }

        .search-result-icon { font-size: 16px; opacity: 0.5; }

        .search-result-text {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-loading {
            padding: 16px;
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-size: 13px;
        }

        /* ===== LOCATIONS LIST ===== */
        .locations-section-title {
            font-size: 14px;
            font-weight: 700;
            color: rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .locations-count {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            padding: 2px 10px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
        }

        .locations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 60px;
        }

        .empty-state {
            text-align: center;
            padding: 30px 16px;
            color: rgba(255,255,255,0.3);
        }

        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 12px;
            animation: bounce 2s ease-in-out infinite;
        }

        .empty-state p { font-size: 13px; line-height: 1.6; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* ===== LOCATION CARD ===== */
        .location-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            transition: all 0.3s;
            cursor: pointer;
        }

        .location-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.15);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .location-card-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .location-card-info { flex: 1; min-width: 0; }

        .location-card-name {
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .location-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 3px;
        }

        .location-card-freq {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 50px;
            font-weight: 600;
        }

        .location-card-delete {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.3);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .location-card-delete:hover {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* ===== ADD LOCATION FORM ===== */
        .add-form {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .add-form.show { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .add-form-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .add-form-close {
            width: 28px; height: 28px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-form-close:hover { background: rgba(255,255,255,0.15); color: #fff; }

        .form-group { margin-bottom: 16px; }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .form-input:focus {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.08);
        }

        .form-input.readonly-subtle {
            color: rgba(255,255,255,0.45);
            font-size: 13px;
        }

        /* ===== QUICK NAME TAGS ===== */
        .quick-names {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .quick-name {
            padding: 5px 12px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04);
            color: rgba(255,255,255,0.55);
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quick-name:hover {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }

        /* ===== CHIPS ===== */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: rgba(255,255,255,0.6);
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chip:hover { background: rgba(255,255,255,0.08); color: #fff; }

        .chip.selected {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #6ee7b7;
        }

        /* ===== BUTTONS ===== */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary.loading { pointer-events: none; }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: rgba(255,255,255,0.7);
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover { background: rgba(255,255,255,0.1); color: #fff; }

        .btn-add {
            padding: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-add:hover { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }

        /* ===== RESULT CARD ===== */
        .result-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 18px;
            padding: 24px;
            display: none;
            animation: resultReveal 0.5s ease;
        }

        .result-card.show { display: block; }

        @keyframes resultReveal {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .result-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16, 185, 129, 0.25);
            color: #6ee7b7;
            padding: 4px 14px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 14px;
        }

        .result-neighborhood {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .result-desc {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            line-height: 1.6;
            margin-bottom: 18px;
        }

        /* ===== JUSTIFICATION ===== */
        .result-justification {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 18px;
        }

        .justification-title {
            font-size: 12px;
            font-weight: 700;
            color: #6ee7b7;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .justification-text {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            line-height: 1.7;
        }

        .justification-point {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 4px;
        }

        .justification-point span:first-child {
            color: #10b981;
            flex-shrink: 0;
        }

        /* ===== DISTANCES ===== */
        .result-distances {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 18px;
        }

        .result-distance-item {
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 13px;
        }

        .result-distance-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .result-distance-name {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            font-weight: 700;
        }

        .result-distance-name span:last-child {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-distance-km {
            font-weight: 700;
            color: #6ee7b7;
            direction: ltr;
            font-size: 13px;
            flex-shrink: 0;
        }

        .result-distance-times {
            display: flex;
            gap: 8px;
        }

        .result-time-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 8px;
            direction: ltr;
        }

        .result-time-normal {
            background: rgba(16, 185, 129, 0.12);
            color: #6ee7b7;
        }

        .result-time-rush {
            background: rgba(239, 68, 68, 0.12);
            color: #fca5a5;
        }

        .result-actions {
            display: flex;
            gap: 8px;
        }

        .result-actions button { flex: 1; }

        /* ===== MAP ===== */
        .map-container {
            flex: 1;
            position: relative;
            order: 1;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: crosshair;
        }

        .map-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 22, 40, 0.85);
            backdrop-filter: blur(10px);
            padding: 24px 36px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            z-index: 500;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .map-overlay.hidden { opacity: 0; }

        .map-overlay-icon {
            font-size: 36px;
            margin-bottom: 8px;
            animation: bounce 2s ease-in-out infinite;
        }

        .map-overlay p {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            font-weight: 600;
        }

        /* ===== CUSTOM MARKERS ===== */
        .custom-marker { background: none; border: none; }

        .marker-pin {
            width: 42px;
            height: 42px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.9);
            animation: markerDrop 0.4s ease-out;
        }

        .marker-pin .marker-icon {
            transform: rotate(45deg);
            font-size: 18px;
            line-height: 1;
        }

        @keyframes markerDrop {
            0% { transform: rotate(-45deg) translateY(-30px); opacity: 0; }
            60% { transform: rotate(-45deg) translateY(3px); }
            100% { transform: rotate(-45deg) translateY(0); opacity: 1; }
        }

        /* ===== MARKER TOOLTIP (distance label near marker) ===== */
        .marker-info-label {
            background: rgba(10, 22, 15, 0.92);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            padding: 5px 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            text-align: center;
            line-height: 1.5;
            color: #fff;
            min-width: 80px;
        }

        .marker-info-km {
            color: #6ee7b7;
        }

        .marker-info-time {
            color: rgba(255,255,255,0.5);
            font-size: 10px;
        }

        .marker-info-rush {
            color: #fca5a5;
            font-size: 10px;
        }

        .centroid-marker-inner {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4), 0 4px 15px rgba(0,0,0,0.3);
            animation: centroidPulse 2s infinite;
        }

        @keyframes centroidPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.6), 0 4px 15px rgba(0,0,0,0.3); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0), 0 4px 15px rgba(0,0,0,0.3); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0), 0 4px 15px rgba(0,0,0,0.3); }
        }

        /* ===== LEAFLET OVERRIDES ===== */
        .leaflet-popup-content-wrapper {
            background: rgba(15, 25, 20, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .leaflet-popup-tip {
            background: rgba(15, 25, 20, 0.95);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .leaflet-popup-content { margin: 14px 16px; font-size: 13px; line-height: 1.6; }
        .popup-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .popup-info { color: rgba(255,255,255,0.5); font-size: 12px; }

        .popup-remove {
            color: #e74c3c;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
            display: inline-block;
            font-family: 'Cairo', sans-serif;
            background: none;
            border: none;
            padding: 0;
        }

        .popup-remove:hover { text-decoration: underline; }

        .leaflet-control-zoom a {
            background: rgba(15, 25, 20, 0.9) !important;
            color: #fff !important;
            border-color: rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(10px);
        }

        .leaflet-control-zoom a:hover { background: rgba(16, 185, 129, 0.3) !important; }

        .leaflet-control-attribution {
            background: rgba(15, 25, 20, 0.7) !important;
            color: rgba(255,255,255,0.4) !important;
            font-size: 10px !important;
        }

        .leaflet-control-attribution a { color: rgba(255,255,255,0.5) !important; }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(10, 22, 15, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            padding: 12px 24px;
            border-radius: 14px;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ===== HOW IT WORKS ===== */
        .how-it-works {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            padding: 16px;
        }

        .how-it-works-title {
            font-size: 13px;
            font-weight: 700;
            color: rgba(255,255,255,0.5);
            margin-bottom: 12px;
        }

        .how-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
        }

        .how-step-num {
            width: 24px; height: 24px;
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            flex-shrink: 0;
        }

        .how-step-text {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            line-height: 1.5;
        }

        /* ===== BROKER FORM ===== */
        .broker-section {
            display: none;
            animation: resultReveal 0.5s ease;
        }

        .broker-section.show {
            display: block;
        }

        .broker-cta {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(217, 119, 6, 0.08));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 18px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .broker-cta-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .broker-cta-title {
            font-size: 17px;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .broker-cta-desc {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .broker-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .broker-form.show {
            display: block;
        }

        .broker-form-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
        }

        .broker-form-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .broker-step-label {
            font-size: 11px;
            font-weight: 700;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            padding: 2px 10px;
            border-radius: 50px;
        }

        .form-select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff50' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 14px center;
        }

        [dir="ltr"] .form-select {
            background-position: right 14px center;
        }

        .form-select:focus {
            border-color: #f59e0b;
            background-color: rgba(245, 158, 11, 0.08);
        }

        .form-select option {
            background: #1a2332;
            color: #fff;
        }

        .form-textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
            resize: vertical;
            min-height: 70px;
        }

        .form-textarea:focus {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.08);
        }

        .form-textarea::placeholder {
            color: rgba(255,255,255,0.3);
        }

        .phone-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phone-prefix {
            padding: 12px 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: rgba(255,255,255,0.6);
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 700;
            direction: ltr;
            flex-shrink: 0;
        }

        .phone-input {
            flex: 1;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
            direction: ltr;
            text-align: left;
        }

        .phone-input:focus {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.08);
        }

        .phone-input::placeholder {
            color: rgba(255,255,255,0.3);
            text-align: right;
        }

        [dir="ltr"] .phone-input::placeholder {
            text-align: left;
        }

        .btn-broker {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-broker:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .btn-broker:active { transform: translateY(0); }

        .btn-broker:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-broker-outline {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 2px solid rgba(245, 158, 11, 0.4);
            border-radius: 14px;
            color: #f59e0b;
            font-family: 'Cairo', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-broker-outline:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
        }

        /* Success state */
        .broker-success {
            display: none;
            text-align: center;
            padding: 30px 20px;
            animation: resultReveal 0.5s ease;
        }

        .broker-success.show {
            display: block;
        }

        .broker-success-icon {
            font-size: 50px;
            margin-bottom: 12px;
        }

        .broker-success-title {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 8px;
            color: #10b981;
        }

        .broker-success-desc {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            line-height: 1.7;
        }

        /* Property type cards */
        .property-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .property-type-btn {
            padding: 12px 8px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: rgba(255,255,255,0.6);
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .property-type-btn:hover {
            background: rgba(255,255,255,0.08);
            color: #fff;
        }

        .property-type-btn.selected {
            background: rgba(245, 158, 11, 0.15);
            border-color: #f59e0b;
            color: #fbbf24;
        }

        .property-type-icon {
            font-size: 22px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body { overflow: auto; }

            .app-layout {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 62px);
            }

            [dir="rtl"] .app-layout { flex-direction: column; }

            .sidebar {
                width: 100%;
                min-width: unset;
                order: 2;
                border: none;
                border-top: 1px solid rgba(255,255,255,0.08);
                min-height: auto;
            }

            .map-container {
                height: 50vh;
                min-height: 300px;
                order: 1;
            }

            .nav-title { font-size: 16px; }
        }

        @media (max-width: 480px) {
            .sidebar { padding: 16px; }
            .nav { padding: 10px 16px; }
            .chips-container { gap: 6px; }
            .chip { padding: 6px 10px; font-size: 11px; }
            .result-distance-times { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

    <!-- NAV -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-logo">üè†</div>
            <span class="nav-title" data-ar="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ" data-en="Where to Live">ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ</span>
        </div>
        <div class="nav-actions">
            <button class="lang-btn active" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
        </div>
    </nav>

    <!-- APP LAYOUT -->
    <div class="app-layout">

        <!-- MAP -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-overlay" id="mapOverlay">
                <div class="map-overlay-icon">üìç</div>
                <p data-ar="ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàŸÇÿπ" data-en="Click on the map to add a location">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàŸÇÿπ</p>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">

            <!-- HEADER -->
            <div class="sidebar-header">
                <h2 data-ar="ÿßŸÉÿ™ÿ¥ŸÅ ŸÖŸÜÿ∑ŸÇÿ™ŸÉ ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©" data-en="Find Your Optimal Area">ÿßŸÉÿ™ÿ¥ŸÅ ŸÖŸÜÿ∑ŸÇÿ™ŸÉ ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©</h2>
                <p data-ar="ÿ≠ÿØÿØ ÿßŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÑŸä ÿ™ÿ≤Ÿàÿ±Ÿáÿß ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ŸÉÿ±ÿ± Ÿàÿ±ÿßÿ≠ ŸÜÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂" data-en="Mark the places you frequently visit and we'll calculate the best area for you to live in Riyadh">ÿ≠ÿØÿØ ÿßŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÑŸä ÿ™ÿ≤Ÿàÿ±Ÿáÿß ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ŸÉÿ±ÿ± Ÿàÿ±ÿßÿ≠ ŸÜÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÑÿ≥ŸÉŸÜ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂</p>
            </div>

            <!-- SEARCH -->
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput"
                    placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸàŸÇÿπ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂..."
                    data-ar-ph="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸàŸÇÿπ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂..."
                    data-en-ph="Search for a location in Riyadh..."
                    autocomplete="off">
                <span class="search-icon">üîç</span>
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- LOCATIONS LIST -->
            <div>
                <div class="locations-section-title">
                    <span data-ar="ÿßŸÑŸÖŸàÿßŸÇÿπ ÿßŸÑŸÖÿ≠ÿØÿØÿ©" data-en="Selected Locations">ÿßŸÑŸÖŸàÿßŸÇÿπ ÿßŸÑŸÖÿ≠ÿØÿØÿ©</span>
                    <span class="locations-count" id="locationsCount">0</span>
                </div>
                <div class="locations-list" id="locationsList">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">üìç</div>
                        <p data-ar="ÿßÿ®ÿ≠ÿ´ ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÖÿßŸÉŸÜŸÉ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©" data-en="Search or click on the map to add your frequent places">ÿßÿ®ÿ≠ÿ´ ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÖÿßŸÉŸÜŸÉ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©</p>
                    </div>
                </div>
            </div>

            <!-- ADD LOCATION FORM -->
            <div class="add-form" id="addForm">
                <div class="add-form-title">
                    <span data-ar="ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàŸÇÿπ" data-en="Add Location">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàŸÇÿπ</span>
                    <button class="add-form-close" onclick="closeAddForm()">‚úï</button>
                </div>

                <!-- NEIGHBORHOOD NAME (auto from map) -->
                <div class="form-group">
                    <label class="form-label" data-ar="üìç ÿßŸÑÿ≠Ÿä" data-en="üìç Neighborhood">üìç ÿßŸÑÿ≠Ÿä</label>
                    <input type="text" class="form-input readonly-subtle" id="locationNeighborhood" readonly
                        placeholder="Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØŸá ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß..."
                        data-ar-ph="Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØŸá ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß..."
                        data-en-ph="Detected automatically...">
                </div>

                <!-- USER'S CUSTOM NAME -->
                <div class="form-group">
                    <label class="form-label" data-ar="‚úèÔ∏è ÿ≥ŸÖŸë Ÿáÿ∞ÿß ÿßŸÑŸÖŸÉÿßŸÜ" data-en="‚úèÔ∏è Name this place">‚úèÔ∏è ÿ≥ŸÖŸë Ÿáÿ∞ÿß ÿßŸÑŸÖŸÉÿßŸÜ</label>
                    <input type="text" class="form-input" id="locationName"
                        placeholder="ŸÖÿ´ÿßŸÑ: ÿ®Ÿäÿ™ ÿßŸÑÿ£ŸáŸÑÿå ÿ¨ÿßŸÖÿπÿ© ÿßŸÑÿ®ŸÜÿßÿ™ÿå ÿßŸÑŸÖŸÉÿ™ÿ®..."
                        data-ar-ph="ŸÖÿ´ÿßŸÑ: ÿ®Ÿäÿ™ ÿßŸÑÿ£ŸáŸÑÿå ÿ¨ÿßŸÖÿπÿ© ÿßŸÑÿ®ŸÜÿßÿ™ÿå ÿßŸÑŸÖŸÉÿ™ÿ®..."
                        data-en-ph="e.g. Family home, University, Office...">
                    <div class="quick-names" id="quickNames">
                        <button class="quick-name" onclick="setQuickName('üíº', 'ÿßŸÑÿπŸÖŸÑ', 'Work')">
                            <span>üíº</span> <span data-ar="ÿßŸÑÿπŸÖŸÑ" data-en="Work">ÿßŸÑÿπŸÖŸÑ</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üè°', 'ÿ®Ÿäÿ™ ÿßŸÑÿ£ŸáŸÑ', 'Family Home')">
                            <span>üè°</span> <span data-ar="ÿ®Ÿäÿ™ ÿßŸÑÿ£ŸáŸÑ" data-en="Family Home">ÿ®Ÿäÿ™ ÿßŸÑÿ£ŸáŸÑ</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üè†', 'ÿßŸÑŸÖŸÜÿ≤ŸÑ', 'Home')">
                            <span>üè†</span> <span data-ar="ÿßŸÑŸÖŸÜÿ≤ŸÑ" data-en="Home">ÿßŸÑŸÖŸÜÿ≤ŸÑ</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üå¥', 'ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©', 'Rest House')">
                            <span>üå¥</span> <span data-ar="ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©" data-en="Rest House">ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üéì', 'ÿßŸÑÿ¨ÿßŸÖÿπÿ©', 'University')">
                            <span>üéì</span> <span data-ar="ÿßŸÑÿ¨ÿßŸÖÿπÿ©" data-en="University">ÿßŸÑÿ¨ÿßŸÖÿπÿ©</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üèãÔ∏è', 'ÿßŸÑŸÜÿßÿØŸä', 'Gym')">
                            <span>üèãÔ∏è</span> <span data-ar="ÿßŸÑŸÜÿßÿØŸä" data-en="Gym">ÿßŸÑŸÜÿßÿØŸä</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üè¢', 'ÿßŸÑŸÖŸÉÿ™ÿ®', 'Office')">
                            <span>üè¢</span> <span data-ar="ÿßŸÑŸÖŸÉÿ™ÿ®" data-en="Office">ÿßŸÑŸÖŸÉÿ™ÿ®</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üõí', 'ÿßŸÑÿ≥ŸàŸÇ', 'Market')">
                            <span>üõí</span> <span data-ar="ÿßŸÑÿ≥ŸàŸÇ" data-en="Market">ÿßŸÑÿ≥ŸàŸÇ</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üè´', 'ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©', 'School')">
                            <span>üè´</span> <span data-ar="ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©" data-en="School">ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©</span>
                        </button>
                        <button class="quick-name" onclick="setQuickName('üïå', 'ÿßŸÑŸÖÿ≥ÿ¨ÿØ', 'Mosque')">
                            <span>üïå</span> <span data-ar="ÿßŸÑŸÖÿ≥ÿ¨ÿØ" data-en="Mosque">ÿßŸÑŸÖÿ≥ÿ¨ÿØ</span>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" data-ar="üîÑ ÿπÿØÿØ ŸÖÿ±ÿßÿ™ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©" data-en="üîÑ Visit Frequency">üîÑ ÿπÿØÿØ ŸÖÿ±ÿßÿ™ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©</label>
                    <div class="chips-container" id="freqChips">
                        <button class="chip selected" data-freq="daily" onclick="selectFreq(this)">
                            <span data-ar="ŸäŸàŸÖŸäŸãÿß" data-en="Daily">ŸäŸàŸÖŸäŸãÿß</span>
                        </button>
                        <button class="chip" data-freq="weekly" onclick="selectFreq(this)">
                            <span data-ar="ÿ£ÿ≥ÿ®ŸàÿπŸäŸãÿß" data-en="Weekly">ÿ£ÿ≥ÿ®ŸàÿπŸäŸãÿß</span>
                        </button>
                        <button class="chip" data-freq="monthly" onclick="selectFreq(this)">
                            <span data-ar="ÿ¥Ÿáÿ±ŸäŸãÿß" data-en="Monthly">ÿ¥Ÿáÿ±ŸäŸãÿß</span>
                        </button>
                    </div>
                </div>

                <button class="btn-add" onclick="confirmAddLocation()" data-ar="ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàŸÇÿπ ‚ûï" data-en="Add Location ‚ûï">ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàŸÇÿπ ‚ûï</button>
            </div>

            <!-- CALCULATE BUTTON -->
            <button class="btn-primary" id="calculateBtn" onclick="calculateOptimal()" disabled>
                <span>‚ú®</span>
                <span data-ar="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü" data-en="Where should I live?">ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü</span>
            </button>

            <!-- RESULT CARD -->
            <div class="result-card" id="resultCard">
                <div class="result-badge">
                    <span>üéØ</span>
                    <span data-ar="ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©" data-en="Optimal Area">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©</span>
                </div>
                <div class="result-neighborhood" id="resultNeighborhood">---</div>
                <div class="result-desc" id="resultDesc"></div>

                <div class="result-justification" id="resultJustification"></div>

                <div class="result-distances" id="resultDistances"></div>
                <div class="result-actions">
                    <button class="btn-secondary" onclick="resetAll()">
                        <span data-ar="üîÑ ŸÖŸÜ ÿ¨ÿØŸäÿØ" data-en="üîÑ Reset">üîÑ ŸÖŸÜ ÿ¨ÿØŸäÿØ</span>
                    </button>
                    <button class="btn-secondary" onclick="shareResult()">
                        <span data-ar="üìã ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©" data-en="üìã Copy Result">üìã ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©</span>
                    </button>
                </div>
            </div>

            <!-- BROKER SECTION -->
            <div class="broker-section" id="brokerSection">
                <div class="broker-cta" id="brokerCta">
                    <div class="broker-cta-icon">üè°</div>
                    <div class="broker-cta-title" data-ar="ÿ™ÿ®Ÿä Ÿàÿ≥ÿ∑ÿßÿ° ÿπŸÇÿßÿ±ŸäŸäŸÜ Ÿäÿ™ŸàÿßÿµŸÑŸàŸÜ ŸÖÿπŸÉÿü" data-en="Want real estate agents to contact you?">ÿ™ÿ®Ÿä Ÿàÿ≥ÿ∑ÿßÿ° ÿπŸÇÿßÿ±ŸäŸäŸÜ Ÿäÿ™ŸàÿßÿµŸÑŸàŸÜ ŸÖÿπŸÉÿü</div>
                    <div class="broker-cta-desc" data-ar="ÿ≠ÿ∑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ Ÿàÿ®Ÿäÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ Ÿàÿ≥ÿ∑ÿßÿ° ÿπŸÇÿßÿ±ŸäŸäŸÜ ŸÖÿ™ÿÆÿµÿµŸäŸÜ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿ©" data-en="Share your details and specialized real estate agents in the suggested area will reach out to you">ÿ≠ÿ∑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ Ÿàÿ®Ÿäÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ Ÿàÿ≥ÿ∑ÿßÿ° ÿπŸÇÿßÿ±ŸäŸäŸÜ ŸÖÿ™ÿÆÿµÿµŸäŸÜ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿ©</div>
                    <button class="btn-broker-outline" onclick="showBrokerForm()">
                        <span>üìã</span>
                        <span data-ar="ŸÜÿπŸÖÿå ÿ£ÿ®Ÿä Ÿàÿ≥Ÿäÿ∑ ÿπŸÇÿßÿ±Ÿä" data-en="Yes, I want a broker">ŸÜÿπŸÖÿå ÿ£ÿ®Ÿä Ÿàÿ≥Ÿäÿ∑ ÿπŸÇÿßÿ±Ÿä</span>
                    </button>
                </div>

                <div class="broker-form" id="brokerForm">
                    <div class="broker-form-card">
                        <div class="broker-form-title">
                            <span>üìã</span>
                            <span data-ar="ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®" data-en="Request Details">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®</span>
                        </div>

                        <!-- Property Type -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ°" data-en="1">Ÿ°</span>
                                <span data-ar=" Ÿàÿ¥ ŸÜŸàÿπ ÿßŸÑÿπŸÇÿßÿ± ÿßŸÑŸÑŸä ÿ™ÿ®ŸäŸáÿü" data-en=" What property type do you want?"> Ÿàÿ¥ ŸÜŸàÿπ ÿßŸÑÿπŸÇÿßÿ± ÿßŸÑŸÑŸä ÿ™ÿ®ŸäŸáÿü</span>
                            </label>
                            <div class="property-types" id="propertyTypes">
                                <button class="property-type-btn" data-type="land" onclick="selectProperty(this)">
                                    <span class="property-type-icon">üèóÔ∏è</span>
                                    <span data-ar="ÿ£ÿ±ÿ∂" data-en="Land">ÿ£ÿ±ÿ∂</span>
                                </button>
                                <button class="property-type-btn" data-type="villa" onclick="selectProperty(this)">
                                    <span class="property-type-icon">üè°</span>
                                    <span data-ar="ŸÅŸäŸÑÿß" data-en="Villa">ŸÅŸäŸÑÿß</span>
                                </button>
                                <button class="property-type-btn" data-type="apartment" onclick="selectProperty(this)">
                                    <span class="property-type-icon">üè¢</span>
                                    <span data-ar="ÿ¥ŸÇÿ©" data-en="Apartment">ÿ¥ŸÇÿ©</span>
                                </button>
                                <button class="property-type-btn" data-type="duplex" onclick="selectProperty(this)">
                                    <span class="property-type-icon">üèòÔ∏è</span>
                                    <span data-ar="ÿØÿ®ŸÑŸÉÿ≥" data-en="Duplex">ÿØÿ®ŸÑŸÉÿ≥</span>
                                </button>
                                <button class="property-type-btn" data-type="floor" onclick="selectProperty(this)">
                                    <span class="property-type-icon">üè†</span>
                                    <span data-ar="ÿØŸàÿ±" data-en="Floor">ÿØŸàÿ±</span>
                                </button>
                                <button class="property-type-btn" data-type="townhouse" onclick="selectProperty(this)">
                                    <span class="property-type-icon">üèöÔ∏è</span>
                                    <span data-ar="ÿ™ÿßŸàŸÜ ŸáÿßŸàÿ≥" data-en="Townhouse">ÿ™ÿßŸàŸÜ ŸáÿßŸàÿ≥</span>
                                </button>
                            </div>
                        </div>

                        <!-- Buy or Rent -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ¢" data-en="2">Ÿ¢</span>
                                <span data-ar=" ÿ¥ÿ±ÿßÿ° ÿ£Ÿà ÿ•Ÿäÿ¨ÿßÿ±ÿü" data-en=" Buy or Rent?"> ÿ¥ÿ±ÿßÿ° ÿ£Ÿà ÿ•Ÿäÿ¨ÿßÿ±ÿü</span>
                            </label>
                            <div class="chips-container" id="purposeChips">
                                <button class="chip" data-purpose="buy" onclick="selectPurpose(this)">
                                    <span>üîë</span>
                                    <span data-ar="ÿ¥ÿ±ÿßÿ°" data-en="Buy">ÿ¥ÿ±ÿßÿ°</span>
                                </button>
                                <button class="chip" data-purpose="rent" onclick="selectPurpose(this)">
                                    <span>üìù</span>
                                    <span data-ar="ÿ•Ÿäÿ¨ÿßÿ±" data-en="Rent">ÿ•Ÿäÿ¨ÿßÿ±</span>
                                </button>
                            </div>
                        </div>

                        <!-- Budget -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ£" data-en="3">Ÿ£</span>
                                <span data-ar=" ŸÉŸÖ ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉÿü" data-en=" What's your budget?"> ŸÉŸÖ ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉÿü</span>
                            </label>
                            <select class="form-select" id="budgetSelect">
                                <option value="" disabled selected data-ar="ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©..." data-en="Choose budget...">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©...</option>
                                <option value="under500k">ÿ£ŸÇŸÑ ŸÖŸÜ 500 ÿ£ŸÑŸÅ</option>
                                <option value="500k-1m">500 ÿ£ŸÑŸÅ - 1 ŸÖŸÑŸäŸàŸÜ</option>
                                <option value="1m-1.5m">1 ŸÖŸÑŸäŸàŸÜ - 1.5 ŸÖŸÑŸäŸàŸÜ</option>
                                <option value="1.5m-2m">1.5 ŸÖŸÑŸäŸàŸÜ - 2 ŸÖŸÑŸäŸàŸÜ</option>
                                <option value="2m-3m">2 ŸÖŸÑŸäŸàŸÜ - 3 ŸÖŸÑŸäŸàŸÜ</option>
                                <option value="above3m">ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 3 ŸÖŸÑŸäŸàŸÜ</option>
                            </select>
                        </div>

                        <!-- Rooms -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ§" data-en="4">Ÿ§</span>
                                <span data-ar=" ŸÉŸÖ ÿπÿØÿØ ÿßŸÑÿ∫ÿ±ŸÅÿü" data-en=" How many rooms?"> ŸÉŸÖ ÿπÿØÿØ ÿßŸÑÿ∫ÿ±ŸÅÿü</span>
                            </label>
                            <div class="chips-container" id="roomsChips">
                                <button class="chip" data-rooms="2" onclick="selectRooms(this)">2</button>
                                <button class="chip" data-rooms="3" onclick="selectRooms(this)">3</button>
                                <button class="chip" data-rooms="4" onclick="selectRooms(this)">4</button>
                                <button class="chip" data-rooms="5" onclick="selectRooms(this)">5</button>
                                <button class="chip" data-rooms="6+" onclick="selectRooms(this)">6+</button>
                            </div>
                        </div>

                        <!-- Family Size -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ•" data-en="5">Ÿ•</span>
                                <span data-ar=" ŸÉŸÖ ÿπÿØÿØ ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿ£ÿ≥ÿ±ÿ©ÿü" data-en=" Family size?"> ŸÉŸÖ ÿπÿØÿØ ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿ£ÿ≥ÿ±ÿ©ÿü</span>
                            </label>
                            <div class="chips-container" id="familyChips">
                                <button class="chip" data-family="1-2" onclick="selectFamily(this)">
                                    <span data-ar="1-2 ÿ£ŸÅÿ±ÿßÿØ" data-en="1-2">1-2 ÿ£ŸÅÿ±ÿßÿØ</span>
                                </button>
                                <button class="chip" data-family="3-4" onclick="selectFamily(this)">
                                    <span data-ar="3-4 ÿ£ŸÅÿ±ÿßÿØ" data-en="3-4">3-4 ÿ£ŸÅÿ±ÿßÿØ</span>
                                </button>
                                <button class="chip" data-family="5-6" onclick="selectFamily(this)">
                                    <span data-ar="5-6 ÿ£ŸÅÿ±ÿßÿØ" data-en="5-6">5-6 ÿ£ŸÅÿ±ÿßÿØ</span>
                                </button>
                                <button class="chip" data-family="7+" onclick="selectFamily(this)">
                                    <span data-ar="7+ ÿ£ŸÅÿ±ÿßÿØ" data-en="7+">7+ ÿ£ŸÅÿ±ÿßÿØ</span>
                                </button>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ¶" data-en="6">Ÿ¶</span>
                                <span data-ar=" ŸÖÿ™Ÿâ ÿ™ÿ®Ÿä ÿ™ŸÜÿ™ŸÇŸÑÿü" data-en=" When do you plan to move?"> ŸÖÿ™Ÿâ ÿ™ÿ®Ÿä ÿ™ŸÜÿ™ŸÇŸÑÿü</span>
                            </label>
                            <div class="chips-container" id="timelineChips">
                                <button class="chip" data-timeline="asap" onclick="selectTimeline(this)">
                                    <span data-ar="ŸÅŸä ÿ£ŸÇÿ±ÿ® ŸàŸÇÿ™" data-en="ASAP">ŸÅŸä ÿ£ŸÇÿ±ÿ® ŸàŸÇÿ™</span>
                                </button>
                                <button class="chip" data-timeline="1-3months" onclick="selectTimeline(this)">
                                    <span data-ar="ÿÆŸÑÿßŸÑ 1-3 ÿ£ÿ¥Ÿáÿ±" data-en="1-3 months">ÿÆŸÑÿßŸÑ 1-3 ÿ£ÿ¥Ÿáÿ±</span>
                                </button>
                                <button class="chip" data-timeline="3-6months" onclick="selectTimeline(this)">
                                    <span data-ar="ÿÆŸÑÿßŸÑ 3-6 ÿ£ÿ¥Ÿáÿ±" data-en="3-6 months">ÿÆŸÑÿßŸÑ 3-6 ÿ£ÿ¥Ÿáÿ±</span>
                                </button>
                                <button class="chip" data-timeline="exploring" onclick="selectTimeline(this)">
                                    <span data-ar="ÿ£ÿ≥ÿ™ŸÉÿ¥ŸÅ ÿ®ÿ≥" data-en="Just exploring">ÿ£ÿ≥ÿ™ŸÉÿ¥ŸÅ ÿ®ÿ≥</span>
                                </button>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿß" data-en="7">Ÿß</span>
                                <span data-ar=" ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" data-en=" Additional notes (optional)"> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</span>
                            </label>
                            <textarea class="form-textarea" id="brokerNotes"
                                placeholder="ŸÖÿ´ÿßŸÑ: ÿ£ÿ®Ÿä ÿ®Ÿäÿ™ ŸÇÿ±Ÿäÿ® ŸÖŸÜ ŸÖÿØÿ±ÿ≥ÿ©ÿå ÿ£Ÿà ÿ£ÿ®Ÿä ÿ¨ÿ±ÿßÿ¨ Ÿäÿ≥ÿπ ÿ≥Ÿäÿßÿ±ÿ™ŸäŸÜ..."
                                data-ar-ph="ŸÖÿ´ÿßŸÑ: ÿ£ÿ®Ÿä ÿ®Ÿäÿ™ ŸÇÿ±Ÿäÿ® ŸÖŸÜ ŸÖÿØÿ±ÿ≥ÿ©ÿå ÿ£Ÿà ÿ£ÿ®Ÿä ÿ¨ÿ±ÿßÿ¨ Ÿäÿ≥ÿπ ÿ≥Ÿäÿßÿ±ÿ™ŸäŸÜ..."
                                data-en-ph="e.g. I want a house near a school, or a garage for 2 cars..."></textarea>
                        </div>

                        <!-- Phone -->
                        <div class="form-group">
                            <label class="form-label">
                                <span class="broker-step-label" data-ar="Ÿ®" data-en="8">Ÿ®</span>
                                <span data-ar=" ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ ŸÑŸÑÿ™ŸàÿßÿµŸÑ" data-en=" Your phone number"> ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ ŸÑŸÑÿ™ŸàÿßÿµŸÑ</span>
                            </label>
                            <div class="phone-input-wrapper">
                                <span class="phone-prefix">+966</span>
                                <input type="tel" class="phone-input" id="brokerPhone"
                                    placeholder="5XXXXXXXX"
                                    maxlength="9"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                        </div>

                        <button class="btn-broker" id="brokerSubmitBtn" onclick="submitBrokerForm()" disabled>
                            <span>üì§</span>
                            <span data-ar="ÿ£ÿ±ÿ≥ŸÑ ÿ∑ŸÑÿ®Ÿä ŸÑŸÑŸàÿ≥ÿ∑ÿßÿ°" data-en="Send to Brokers">ÿ£ÿ±ÿ≥ŸÑ ÿ∑ŸÑÿ®Ÿä ŸÑŸÑŸàÿ≥ÿ∑ÿßÿ°</span>
                        </button>
                    </div>
                </div>

                <!-- Success -->
                <div class="broker-success" id="brokerSuccess">
                    <div class="broker-success-icon">üéâ</div>
                    <div class="broker-success-title" data-ar="ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!" data-en="Request sent successfully!">ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!</div>
                    <div class="broker-success-desc" data-ar="ÿ±ÿßÿ≠ Ÿäÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ Ÿàÿ≥ÿ∑ÿßÿ° ÿπŸÇÿßÿ±ŸäŸäŸÜ ŸÖÿ™ÿÆÿµÿµŸäŸÜ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿ© ÿÆŸÑÿßŸÑ 24-48 ÿ≥ÿßÿπÿ©. ÿ¥ŸÉÿ±Ÿãÿß ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸÉ ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ!" data-en="Specialized real estate agents in the suggested area will contact you within 24-48 hours. Thanks for using Where to Live!">ÿ±ÿßÿ≠ Ÿäÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ Ÿàÿ≥ÿ∑ÿßÿ° ÿπŸÇÿßÿ±ŸäŸäŸÜ ŸÖÿ™ÿÆÿµÿµŸäŸÜ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿ© ÿÆŸÑÿßŸÑ 24-48 ÿ≥ÿßÿπÿ©. ÿ¥ŸÉÿ±Ÿãÿß ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸÉ ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜ!</div>
                </div>
            </div>

            <!-- HOW IT WORKS -->
            <div class="how-it-works" id="howItWorks">
                <div class="how-it-works-title" data-ar="ŸÉŸäŸÅ ŸäÿπŸÖŸÑÿü" data-en="How it works?">ŸÉŸäŸÅ ŸäÿπŸÖŸÑÿü</div>
                <div class="how-step">
                    <div class="how-step-num">1</div>
                    <div class="how-step-text" data-ar="ÿ£ÿ∂ŸÅ ÿßŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÑŸä ÿ™ÿ±Ÿàÿ≠ ŸÑŸáÿß ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ŸÉÿ±ÿ± Ÿàÿ≥ŸÖŸëŸáÿß ÿ®ŸÜŸÅÿ≥ŸÉ" data-en="Add places you frequently visit and name them yourself">ÿ£ÿ∂ŸÅ ÿßŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÑŸä ÿ™ÿ±Ÿàÿ≠ ŸÑŸáÿß ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ŸÉÿ±ÿ± Ÿàÿ≥ŸÖŸëŸáÿß ÿ®ŸÜŸÅÿ≥ŸÉ</div>
                </div>
                <div class="how-step">
                    <div class="how-step-num">2</div>
                    <div class="how-step-text" data-ar="ÿ≠ÿØÿØ ŸÉŸÖ ŸÖÿ±ÿ© ÿ™ÿ≤Ÿàÿ± ŸÉŸÑ ŸÖŸÉÿßŸÜ (ŸäŸàŸÖŸäŸãÿßÿå ÿ£ÿ≥ÿ®ŸàÿπŸäŸãÿßÿå ÿ¥Ÿáÿ±ŸäŸãÿß)" data-en="Set how often you visit each place">ÿ≠ÿØÿØ ŸÉŸÖ ŸÖÿ±ÿ© ÿ™ÿ≤Ÿàÿ± ŸÉŸÑ ŸÖŸÉÿßŸÜ (ŸäŸàŸÖŸäŸãÿßÿå ÿ£ÿ≥ÿ®ŸàÿπŸäŸãÿßÿå ÿ¥Ÿáÿ±ŸäŸãÿß)</div>
                </div>
                <div class="how-step">
                    <div class="how-step-num">3</div>
                    <div class="how-step-text" data-ar="ÿßÿ∂ÿ∫ÿ∑ 'ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü' Ÿàÿ±ÿßÿ≠ ŸÜÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸàŸÇÿπ ŸÖÿπ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿπÿßÿØŸä ŸàŸàŸÇÿ™ ÿßŸÑÿ≤ÿ≠ŸÖÿ©" data-en="Click 'Where should I live?' and we'll calculate the best spot with normal & rush hour times">ÿßÿ∂ÿ∫ÿ∑ 'ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü' Ÿàÿ±ÿßÿ≠ ŸÜÿ≠ÿ≥ÿ® ŸÑŸÉ ÿ£ŸÅÿ∂ŸÑ ŸÖŸàŸÇÿπ ŸÖÿπ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿπÿßÿØŸä ŸàŸàŸÇÿ™ ÿßŸÑÿ≤ÿ≠ŸÖÿ©</div>
                </div>
            </div>

        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== STATE =====
        let lang = 'ar';
        let locations = [];
        let pendingLocation = null;
        let isCalculated = false;
        let selectedEmoji = 'üìå';

        let map;
        let markersGroup;
        let centroidMarker = null;
        let zoneRect = null;
        let connectionLines = [];
        let distanceLabels = [];
        let tempMarker = null;

        // ===== ICON MAP =====
        const NAME_ICONS = {
            'ÿßŸÑÿπŸÖŸÑ': 'üíº', 'Work': 'üíº',
            'ÿ®Ÿäÿ™ ÿßŸÑÿ£ŸáŸÑ': 'üè°', 'Family Home': 'üè°',
            'ÿßŸÑŸÖŸÜÿ≤ŸÑ': 'üè†', 'Home': 'üè†',
            'ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©': 'üå¥', 'Rest House': 'üå¥',
            'ÿßŸÑÿ¨ÿßŸÖÿπÿ©': 'üéì', 'University': 'üéì',
            'ÿßŸÑŸÜÿßÿØŸä': 'üèãÔ∏è', 'Gym': 'üèãÔ∏è',
            'ÿßŸÑŸÖŸÉÿ™ÿ®': 'üè¢', 'Office': 'üè¢',
            'ÿßŸÑÿ≥ŸàŸÇ': 'üõí', 'Market': 'üõí',
            'ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©': 'üè´', 'School': 'üè´',
            'ÿßŸÑŸÖÿ≥ÿ¨ÿØ': 'üïå', 'Mosque': 'üïå'
        };

        const LOCATION_COLORS = ['#10b981', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];

        const FREQ_WEIGHTS = { daily: 30, weekly: 4, monthly: 1 };

        const FREQ_LABELS = {
            daily:   { ar: 'ŸäŸàŸÖŸäŸãÿß',    en: 'Daily' },
            weekly:  { ar: 'ÿ£ÿ≥ÿ®ŸàÿπŸäŸãÿß', en: 'Weekly' },
            monthly: { ar: 'ÿ¥Ÿáÿ±ŸäŸãÿß',   en: 'Monthly' }
        };

        // ===== SPEED ESTIMATES =====
        const AVG_SPEED_NORMAL = 45;   // km/h normal traffic
        const AVG_SPEED_RUSH   = 22;   // km/h rush hour (peak 7-9 AM, 4-7 PM)

        function estimateMinutes(distKm, speedKmh) {
            return Math.max(1, Math.round((distKm / speedKmh) * 60));
        }

        // ===== MAP INIT =====
        function initMap() {
            map = L.map('map', {
                center: [24.7136, 46.6753],
                zoom: 11,
                zoomControl: true,
                attributionControl: true,
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: true,
                doubleClickZoom: false,
                boxZoom: true,
                keyboard: true
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            markersGroup = L.layerGroup().addTo(map);

            map.on('click', function(e) {
                onMapClick(e.latlng.lat, e.latlng.lng);
            });

            setTimeout(() => map.invalidateSize(), 100);
        }

        // ===== MAP CLICK =====
        function onMapClick(lat, lng) {
            if (isCalculated) return;

            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            tempMarker = L.circleMarker([lat, lng], {
                radius: 10,
                color: '#10b981',
                fillColor: '#10b981',
                fillOpacity: 0.4,
                weight: 2
            }).addTo(map);

            document.getElementById('mapOverlay').classList.add('hidden');

            pendingLocation = { lat, lng };

            // Set neighborhood automatically
            document.getElementById('locationNeighborhood').value = lang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿØ...' : 'Detecting...';
            reverseGeocode(lat, lng).then(name => {
                document.getElementById('locationNeighborhood').value = name;
            });

            // Clear name for user to type
            document.getElementById('locationName').value = '';
            selectedEmoji = 'üìå';

            resetFormSelections();

            document.getElementById('addForm').classList.add('show');
            document.getElementById('addForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Focus the name input so user can type immediately
            setTimeout(() => document.getElementById('locationName').focus(), 300);
        }

        // ===== SEARCH =====
        let searchTimeout = null;

        document.getElementById('searchInput').addEventListener('input', function() {
            const query = this.value.trim();
            const resultsEl = document.getElementById('searchResults');

            if (query.length < 2) { resultsEl.classList.remove('show'); return; }

            clearTimeout(searchTimeout);
            resultsEl.innerHTML = `<div class="search-loading">${lang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...' : 'Searching...'}</div>`;
            resultsEl.classList.add('show');

            searchTimeout = setTimeout(() => searchNominatim(query), 400);
        });

        document.getElementById('searchInput').addEventListener('focus', function() {
            if (this.value.trim().length >= 2) document.getElementById('searchResults').classList.add('show');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) document.getElementById('searchResults').classList.remove('show');
        });

        async function searchNominatim(query) {
            const resultsEl = document.getElementById('searchResults');
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ' ÿßŸÑÿ±Ÿäÿßÿ∂')}&format=json&addressdetails=1&limit=5&viewbox=46.2,25.1,47.2,24.3&bounded=1&accept-language=${lang}`;
                const res = await fetch(url, { headers: { 'User-Agent': 'WainAskan-App/1.0' } });
                const data = await res.json();

                if (data.length === 0) {
                    resultsEl.innerHTML = `<div class="search-loading">${lang === 'ar' ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨' : 'No results found'}</div>`;
                    return;
                }

                resultsEl.innerHTML = data.map(item => `
                    <div class="search-result-item" onclick="selectSearchResult(${item.lat}, ${item.lon}, '${escapeHtml(item.display_name)}')">
                        <span class="search-result-icon">üìç</span>
                        <span class="search-result-text">${item.display_name}</span>
                    </div>
                `).join('');
            } catch (err) {
                resultsEl.innerHTML = `<div class="search-loading">${lang === 'ar' ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´' : 'Search error'}</div>`;
            }
        }

        function selectSearchResult(lat, lng, name) {
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('searchInput').value = '';
            map.flyTo([lat, lng], 14, { duration: 1 });
            setTimeout(() => onMapClick(lat, lng), 300);
        }

        // ===== REVERSE GEOCODE =====
        let lastGeocodeTime = 0;

        async function reverseGeocode(lat, lng) {
            const now = Date.now();
            const wait = Math.max(0, 1100 - (now - lastGeocodeTime));
            if (wait > 0) await new Promise(r => setTimeout(r, wait));
            lastGeocodeTime = Date.now();

            try {
                const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=${lang}`;
                const res = await fetch(url, { headers: { 'User-Agent': 'WainAskan-App/1.0' } });
                const data = await res.json();

                if (data.address) {
                    return data.address.suburb || data.address.neighbourhood || data.address.city_district || data.address.road || data.display_name.split(',')[0];
                }
                return lang === 'ar' ? 'ŸÖŸàŸÇÿπ ŸÖÿ≠ÿØÿØ' : 'Selected Location';
            } catch {
                return lang === 'ar' ? 'ŸÖŸàŸÇÿπ ŸÖÿ≠ÿØÿØ' : 'Selected Location';
            }
        }

        // ===== FORM CONTROLS =====
        let selectedFreq = 'daily';

        function setQuickName(emoji, arName, enName) {
            document.getElementById('locationName').value = lang === 'ar' ? arName : enName;
            selectedEmoji = emoji;
        }

        function selectFreq(el) {
            document.querySelectorAll('#freqChips .chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedFreq = el.dataset.freq;
        }

        function resetFormSelections() {
            selectedFreq = 'daily';
            selectedEmoji = 'üìå';
            document.querySelectorAll('#freqChips .chip').forEach(c => c.classList.remove('selected'));
            document.querySelector('#freqChips .chip[data-freq="daily"]').classList.add('selected');
        }

        function closeAddForm() {
            document.getElementById('addForm').classList.remove('show');
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
            pendingLocation = null;
        }

        function getIconForName(name) {
            if (NAME_ICONS[name]) return NAME_ICONS[name];
            if (selectedEmoji !== 'üìå') return selectedEmoji;
            for (const [key, icon] of Object.entries(NAME_ICONS)) {
                if (name.includes(key) || key.includes(name)) return icon;
            }
            return 'üìå';
        }

        // ===== ADD LOCATION =====
        function confirmAddLocation() {
            if (!pendingLocation) return;

            const name = document.getElementById('locationName').value.trim() ||
                (lang === 'ar' ? 'ŸÖŸàŸÇÿπ ŸÖÿÆÿµÿµ' : 'Custom Location');

            const neighborhood = document.getElementById('locationNeighborhood').value.trim();
            const icon = getIconForName(name);
            const colorIdx = locations.length % LOCATION_COLORS.length;
            const color = LOCATION_COLORS[colorIdx];

            const location = {
                id: 'loc_' + Date.now(),
                name: name,
                neighborhood: neighborhood,
                icon: icon,
                lat: pendingLocation.lat,
                lng: pendingLocation.lng,
                frequency: selectedFreq,
                color: color,
                marker: null
            };

            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-pin" style="background: ${color}">
                           <span class="marker-icon">${icon}</span>
                       </div>`,
                iconSize: [42, 48],
                iconAnchor: [21, 48],
                popupAnchor: [0, -48]
            });

            const marker = L.marker([location.lat, location.lng], { icon: markerIcon }).addTo(markersGroup);
            marker.bindPopup(createPopupContent(location));
            location.marker = marker;

            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }

            locations.push(location);
            renderLocationsList();
            closeAddForm();
            updateCalculateButton();

            showToast(lang === 'ar' ? `ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© "${name}"` : `"${name}" added`);
        }

        function createPopupContent(loc) {
            const freqLabel = lang === 'ar' ? FREQ_LABELS[loc.frequency].ar : FREQ_LABELS[loc.frequency].en;
            return `
                <div class="popup-title">${loc.icon} ${loc.name}</div>
                <div class="popup-info">${loc.neighborhood} ¬∑ ${freqLabel}</div>
                <button class="popup-remove" onclick="removeLocation('${loc.id}')">${lang === 'ar' ? 'üóëÔ∏è ÿ≠ÿ∞ŸÅ' : 'üóëÔ∏è Remove'}</button>
            `;
        }

        function removeLocation(id) {
            const idx = locations.findIndex(l => l.id === id);
            if (idx === -1) return;
            const loc = locations[idx];
            if (loc.marker) markersGroup.removeLayer(loc.marker);
            locations.splice(idx, 1);
            map.closePopup();
            renderLocationsList();
            updateCalculateButton();
            if (isCalculated) clearResult();
            showToast(lang === 'ar' ? 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸàŸÇÿπ' : 'Location removed');
        }

        // ===== RENDER LOCATIONS =====
        function renderLocationsList() {
            const listEl = document.getElementById('locationsList');
            const countEl = document.getElementById('locationsCount');
            countEl.textContent = locations.length;

            if (locations.length === 0) {
                listEl.innerHTML = '';
                listEl.appendChild(createEmptyState());
                return;
            }

            listEl.innerHTML = locations.map(loc => {
                const freqLabel = lang === 'ar' ? FREQ_LABELS[loc.frequency].ar : FREQ_LABELS[loc.frequency].en;
                return `
                    <div class="location-card" onclick="focusLocation('${loc.id}')">
                        <div class="location-card-icon" style="background: ${loc.color}20; color: ${loc.color}">${loc.icon}</div>
                        <div class="location-card-info">
                            <div class="location-card-name">${loc.name}</div>
                            <div class="location-card-meta">
                                <span class="location-card-freq" style="background: ${loc.color}20; color: ${loc.color}">${freqLabel}</span>
                            </div>
                        </div>
                        <button class="location-card-delete" onclick="event.stopPropagation(); removeLocation('${loc.id}')">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function createEmptyState() {
            const div = document.createElement('div');
            div.className = 'empty-state';
            div.innerHTML = `
                <div class="empty-state-icon">üìç</div>
                <p>${lang === 'ar' ? 'ÿßÿ®ÿ≠ÿ´ ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÖÿßŸÉŸÜŸÉ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©' : 'Search or click on the map to add your frequent places'}</p>
            `;
            return div;
        }

        function focusLocation(id) {
            const loc = locations.find(l => l.id === id);
            if (loc) { map.flyTo([loc.lat, loc.lng], 15, { duration: 0.8 }); loc.marker.openPopup(); }
        }

        function updateCalculateButton() {
            document.getElementById('calculateBtn').disabled = locations.length < 2;
        }

        // ===== CALCULATE =====
        async function calculateOptimal() {
            if (locations.length < 2) return;

            const btn = document.getElementById('calculateBtn');
            btn.classList.add('loading');
            btn.innerHTML = `<span>‚è≥</span> <span>${lang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ≥ÿßÿ®...' : 'Calculating...'}</span>`;

            clearResult();
            await new Promise(r => setTimeout(r, 500));

            // Weighted centroid
            let totalW = 0, wLat = 0, wLng = 0;
            locations.forEach(loc => {
                const w = FREQ_WEIGHTS[loc.frequency];
                wLat += loc.lat * w;
                wLng += loc.lng * w;
                totalW += w;
            });

            const cLat = wLat / totalW;
            const cLng = wLng / totalW;

            // Centroid marker
            centroidMarker = L.marker([cLat, cLng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div class="centroid-marker-inner"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                }),
                zIndexOffset: 1000
            }).addTo(map);

            // 1km x 1km zone
            const latOff = 0.5 / 111.32;
            const lngOff = 0.5 / (111.32 * Math.cos(cLat * Math.PI / 180));

            zoneRect = L.rectangle([
                [cLat - latOff, cLng - lngOff],
                [cLat + latOff, cLng + lngOff]
            ], {
                color: '#10b981',
                weight: 2,
                fillColor: '#10b981',
                fillOpacity: 0.12,
                dashArray: '8, 6'
            }).addTo(map);

            // Distances & times
            const distData = locations.map(loc => {
                const dist = haversineDistance(cLat, cLng, loc.lat, loc.lng);
                const normalMin = estimateMinutes(dist, AVG_SPEED_NORMAL);
                const rushMin = estimateMinutes(dist, AVG_SPEED_RUSH);
                return { loc, dist, normalMin, rushMin };
            });

            // Draw lines + info labels near each marker
            distData.forEach(({ loc, dist, normalMin, rushMin }) => {
                const line = L.polyline(
                    [[cLat, cLng], [loc.lat, loc.lng]],
                    { color: loc.color, weight: 2, dashArray: '6, 8', opacity: 0.5 }
                ).addTo(map);
                connectionLines.push(line);

                // Info label near the location marker (offset slightly)
                const dText = lang === 'ar' ? 'ÿØ' : 'min';
                const labelHtml = `<div class="marker-info-label">
                    <div class="marker-info-km">${dist.toFixed(1)} km</div>
                    <div class="marker-info-time">üöó ${normalMin} ${dText}</div>
                    <div class="marker-info-rush">üî¥ ${rushMin} ${dText}</div>
                </div>`;

                // Place label near the marker with slight offset
                const offsetLat = (loc.lat - cLat) * 0.15;
                const offsetLng = (loc.lng - cLng) * 0.15;

                const label = L.marker([loc.lat + offsetLat, loc.lng + offsetLng], {
                    icon: L.divIcon({
                        className: '',
                        html: labelHtml,
                        iconSize: [100, 50],
                        iconAnchor: [50, 25]
                    }),
                    interactive: false
                }).addTo(map);
                distanceLabels.push(label);
            });

            // Fly to bounds
            const bounds = L.latLngBounds(locations.map(l => [l.lat, l.lng]));
            bounds.extend([cLat, cLng]);
            map.flyToBounds(bounds.pad(0.2), { duration: 1.2 });

            // Reverse geocode centroid
            const neighborhood = await reverseGeocode(cLat, cLng);

            // Populate result
            document.getElementById('resultNeighborhood').textContent = neighborhood;

            const avgDist = distData.reduce((s, d) => s + d.dist, 0) / distData.length;
            const avgNormal = Math.round(distData.reduce((s, d) => s + d.normalMin, 0) / distData.length);
            const avgRush = Math.round(distData.reduce((s, d) => s + d.rushMin, 0) / distData.length);

            const descText = lang === 'ar'
                ? `ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≥ÿßŸÅÿ©: ${avgDist.toFixed(1)} ŸÉŸÖ ¬∑ ÿπÿßÿØŸä ~${avgNormal} ÿØ ¬∑ ÿ∞ÿ±Ÿàÿ© ~${avgRush} ÿØ`
                : `Avg distance: ${avgDist.toFixed(1)} km ¬∑ Normal ~${avgNormal} min ¬∑ Rush ~${avgRush} min`;
            document.getElementById('resultDesc').textContent = descText;

            buildJustification(distData, cLat, cLng, neighborhood);

            // Distance cards per location
            const distHtml = distData.map(({ loc, dist, normalMin, rushMin }) => {
                const dLabel = lang === 'ar' ? 'ÿØ' : 'min';
                const normalLabel = lang === 'ar' ? 'ÿπÿßÿØŸä' : 'Normal';
                const rushLabel = lang === 'ar' ? 'ÿ∞ÿ±Ÿàÿ©' : 'Rush';
                return `
                    <div class="result-distance-item">
                        <div class="result-distance-header">
                            <div class="result-distance-name">
                                <span>${loc.icon}</span>
                                <span>${loc.name}</span>
                            </div>
                            <span class="result-distance-km">${dist.toFixed(1)} km</span>
                        </div>
                        <div class="result-distance-times">
                            <span class="result-time-badge result-time-normal">üöó ${normalLabel}: ${normalMin} ${dLabel}</span>
                            <span class="result-time-badge result-time-rush">üî¥ ${rushLabel}: ${rushMin} ${dLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('resultDistances').innerHTML = distHtml;
            document.getElementById('resultCard').classList.add('show');
            document.getElementById('howItWorks').style.display = 'none';

            btn.classList.remove('loading');
            btn.innerHTML = `<span>‚ú®</span> <span data-ar="ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü" data-en="Where should I live?">${lang === 'ar' ? 'ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü' : 'Where should I live?'}</span>`;
            btn.disabled = true;

            isCalculated = true;

            // Show broker section
            document.getElementById('brokerSection').classList.add('show');
            document.getElementById('brokerCta').style.display = '';
            document.getElementById('brokerForm').classList.remove('show');
            document.getElementById('brokerSuccess').classList.remove('show');

            showToast(lang === 'ar' ? 'üéØ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©!' : 'üéØ Optimal area found!');
        }

        // ===== JUSTIFICATION =====
        function buildJustification(distData, cLat, cLng, neighborhood) {
            const justEl = document.getElementById('resultJustification');

            const sorted = [...distData].sort((a, b) => FREQ_WEIGHTS[b.loc.frequency] - FREQ_WEIGHTS[a.loc.frequency]);
            const mostVisited = sorted[0];
            const farthest = [...distData].sort((a, b) => b.dist - a.dist)[0];
            const nearest = [...distData].sort((a, b) => a.dist - b.dist)[0];

            const totalTrips = distData.reduce((s, d) => s + FREQ_WEIGHTS[d.loc.frequency], 0);
            const totalKm = distData.reduce((s, d) => s + d.dist * FREQ_WEIGHTS[d.loc.frequency] * 2, 0);
            const totalNormalMin = Math.round(distData.reduce((s, d) => s + d.normalMin * FREQ_WEIGHTS[d.loc.frequency] * 2, 0));
            const totalRushMin = Math.round(distData.reduce((s, d) => s + d.rushMin * FREQ_WEIGHTS[d.loc.frequency] * 2, 0));
            const dailyNormal = Math.round(totalNormalMin / 30);
            const dailyRush = Math.round(totalRushMin / 30);

            let points;
            if (lang === 'ar') {
                points = [
                    `ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÖÿÆÿ™ÿßÿ±ÿ© ŸÑÿ£ŸÜŸáÿß ÿßŸÑÿ£ŸÇÿ±ÿ® ŸÑŸÖŸÉÿßŸÜŸÉ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ≤Ÿäÿßÿ±ÿ© "${mostVisited.loc.name}" (${FREQ_LABELS[mostVisited.loc.frequency].ar}) ŸÖÿπ ŸÖŸàÿßÿ≤ŸÜÿ© ÿ®ÿßŸÇŸä ÿßŸÑÿ£ŸÖÿßŸÉŸÜ.`,
                    `ÿ£ŸÇÿ±ÿ® ŸÖŸÉÿßŸÜ: "${nearest.loc.name}" (${nearest.dist.toFixed(1)} ŸÉŸÖÿå ~${nearest.normalMin} ÿØ ÿπÿßÿØŸä). ÿ£ÿ®ÿπÿØ ŸÖŸÉÿßŸÜ: "${farthest.loc.name}" (${farthest.dist.toFixed(1)} ŸÉŸÖÿå ~${farthest.normalMin} ÿØ ÿπÿßÿØŸä).`,
                    `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ±ÿ≠ŸÑÿßÿ™ŸÉ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©: ${totalTrips} ÿ±ÿ≠ŸÑÿ© ÿ∞Ÿáÿßÿ®ÿå ~${Math.round(totalKm)} ŸÉŸÖ. ŸàŸÇÿ™ ÿßŸÑŸÇŸäÿßÿØÿ©: ~${totalNormalMin} ÿØŸÇŸäŸÇÿ© ÿπÿßÿØŸä / ~${totalRushMin} ÿØŸÇŸäŸÇÿ© ŸàŸÇÿ™ ÿßŸÑÿ∞ÿ±Ÿàÿ©.`,
                    `ŸÖÿπÿØŸÑ ÿßŸÑŸÇŸäÿßÿØÿ© ÿßŸÑŸäŸàŸÖŸä: ~${dailyNormal} ÿØŸÇŸäŸÇÿ© (ÿπÿßÿØŸä) / ~${dailyRush} ÿØŸÇŸäŸÇÿ© (ŸàŸÇÿ™ ÿßŸÑÿ≤ÿ≠ŸÖÿ©).`
                ];
            } else {
                points = [
                    `This area is closest to your most visited place "${mostVisited.loc.name}" (${FREQ_LABELS[mostVisited.loc.frequency].en}) while balancing all locations.`,
                    `Nearest: "${nearest.loc.name}" (${nearest.dist.toFixed(1)} km, ~${nearest.normalMin} min). Farthest: "${farthest.loc.name}" (${farthest.dist.toFixed(1)} km, ~${farthest.normalMin} min).`,
                    `Monthly trips: ${totalTrips} one-way, ~${Math.round(totalKm)} km. Drive time: ~${totalNormalMin} min normal / ~${totalRushMin} min rush hour.`,
                    `Daily driving avg: ~${dailyNormal} min (normal) / ~${dailyRush} min (rush hour).`
                ];
            }

            const title = lang === 'ar' ? 'üí° ŸÑŸÖÿßÿ∞ÿß Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿü' : 'üí° Why this area?';
            justEl.innerHTML = `
                <div class="justification-title">${title}</div>
                <div class="justification-text">
                    ${points.map(p => `<div class="justification-point"><span>‚Ä¢</span><span>${p}</span></div>`).join('')}
                </div>
            `;
        }

        // ===== HAVERSINE =====
        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // ===== CLEAR & RESET =====
        function clearResult() {
            if (centroidMarker) { map.removeLayer(centroidMarker); centroidMarker = null; }
            if (zoneRect) { map.removeLayer(zoneRect); zoneRect = null; }
            connectionLines.forEach(l => map.removeLayer(l)); connectionLines = [];
            distanceLabels.forEach(l => map.removeLayer(l)); distanceLabels = [];
            document.getElementById('resultCard').classList.remove('show');
            document.getElementById('brokerSection').classList.remove('show');
            document.getElementById('howItWorks').style.display = '';
            isCalculated = false;
            updateCalculateButton();
        }

        function resetAll() {
            clearResult();
            locations.forEach(loc => { if (loc.marker) markersGroup.removeLayer(loc.marker); });
            locations = [];
            renderLocationsList();
            updateCalculateButton();
            document.getElementById('mapOverlay').classList.remove('hidden');
            map.flyTo([24.7136, 46.6753], 11, { duration: 1 });
            showToast(lang === 'ar' ? 'ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑' : 'Reset complete');
        }

        // ===== SHARE =====
        function shareResult() {
            const neighborhood = document.getElementById('resultNeighborhood').textContent;
            let totalW = 0, wLat = 0, wLng = 0;
            locations.forEach(loc => { const w = FREQ_WEIGHTS[loc.frequency]; wLat += loc.lat*w; wLng += loc.lng*w; totalW += w; });
            const cLat = wLat/totalW, cLng = wLng/totalW;

            const lines = locations.map(loc => {
                const d = haversineDistance(cLat, cLng, loc.lat, loc.lng);
                const n = estimateMinutes(d, AVG_SPEED_NORMAL);
                const r = estimateMinutes(d, AVG_SPEED_RUSH);
                return lang === 'ar'
                    ? `${loc.icon} ${loc.name}: ${d.toFixed(1)} ŸÉŸÖ (~${n} ÿØ ÿπÿßÿØŸä / ~${r} ÿØ ÿ∞ÿ±Ÿàÿ©)`
                    : `${loc.icon} ${loc.name}: ${d.toFixed(1)} km (~${n} min / ~${r} min rush)`;
            }).join('\n');

            const text = lang === 'ar'
                ? `üè† ŸàŸäŸÜ ÿ£ÿ≥ŸÉŸÜÿü\nÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©: ${neighborhood}\n\n${lines}\n\nüìç wainaskan.sa`
                : `üè† Where to Live?\nOptimal Area: ${neighborhood}\n\n${lines}\n\nüìç wainaskan.sa`;

            navigator.clipboard.writeText(text).then(() => {
                showToast(lang === 'ar' ? 'üìã ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©!' : 'üìã Result copied!');
            }).catch(() => showToast(lang === 'ar' ? '‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ' : '‚ö†Ô∏è Copy failed'));
        }

        // ===== LANGUAGE =====
        function setLang(newLang) {
            lang = newLang;
            document.documentElement.lang = newLang;
            document.documentElement.dir = newLang === 'ar' ? 'rtl' : 'ltr';

            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.lang-btn')[newLang === 'ar' ? 0 : 1].classList.add('active');

            document.querySelectorAll('[data-ar]').forEach(el => {
                el.textContent = newLang === 'ar' ? el.dataset.ar : el.dataset.en;
            });

            document.querySelectorAll('[data-ar-ph]').forEach(el => {
                el.placeholder = newLang === 'ar' ? el.dataset.arPh : el.dataset.enPh;
            });

            renderLocationsList();
            locations.forEach(loc => { if (loc.marker) loc.marker.setPopupContent(createPopupContent(loc)); });
            setTimeout(() => map.invalidateSize(), 100);
        }

        // ===== TOAST =====
        let toastTimeout;
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ===== UTILS =====
        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML.replace(/'/g, "\\'");
        }

        // ===== BROKER FORM =====
        let brokerData = {
            propertyType: null,
            purpose: null,
            rooms: null,
            family: null,
            timeline: null
        };

        function showBrokerForm() {
            document.getElementById('brokerCta').style.display = 'none';
            document.getElementById('brokerForm').classList.add('show');
            document.getElementById('brokerForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function selectProperty(el) {
            document.querySelectorAll('#propertyTypes .property-type-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.propertyType = el.dataset.type;
            checkBrokerFormValid();
        }

        function selectPurpose(el) {
            document.querySelectorAll('#purposeChips .chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.purpose = el.dataset.purpose;

            // Update budget options based on buy/rent
            updateBudgetOptions(brokerData.purpose);
            checkBrokerFormValid();
        }

        function updateBudgetOptions(purpose) {
            const sel = document.getElementById('budgetSelect');
            sel.innerHTML = '';

            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.disabled = true;
            defaultOpt.selected = true;
            defaultOpt.textContent = lang === 'ar' ? 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©...' : 'Choose budget...';
            sel.appendChild(defaultOpt);

            let options;
            if (purpose === 'rent') {
                options = lang === 'ar'
                    ? [
                        { v: 'under15k', t: 'ÿ£ŸÇŸÑ ŸÖŸÜ 15 ÿ£ŸÑŸÅ ÿ≥ŸÜŸàŸäŸãÿß' },
                        { v: '15k-25k', t: '15 - 25 ÿ£ŸÑŸÅ ÿ≥ŸÜŸàŸäŸãÿß' },
                        { v: '25k-40k', t: '25 - 40 ÿ£ŸÑŸÅ ÿ≥ŸÜŸàŸäŸãÿß' },
                        { v: '40k-60k', t: '40 - 60 ÿ£ŸÑŸÅ ÿ≥ŸÜŸàŸäŸãÿß' },
                        { v: '60k-100k', t: '60 - 100 ÿ£ŸÑŸÅ ÿ≥ŸÜŸàŸäŸãÿß' },
                        { v: 'above100k', t: 'ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 100 ÿ£ŸÑŸÅ ÿ≥ŸÜŸàŸäŸãÿß' }
                    ]
                    : [
                        { v: 'under15k', t: 'Under 15K/year' },
                        { v: '15k-25k', t: '15K - 25K/year' },
                        { v: '25k-40k', t: '25K - 40K/year' },
                        { v: '40k-60k', t: '40K - 60K/year' },
                        { v: '60k-100k', t: '60K - 100K/year' },
                        { v: 'above100k', t: 'Above 100K/year' }
                    ];
            } else {
                options = lang === 'ar'
                    ? [
                        { v: 'under500k', t: 'ÿ£ŸÇŸÑ ŸÖŸÜ 500 ÿ£ŸÑŸÅ' },
                        { v: '500k-1m', t: '500 ÿ£ŸÑŸÅ - 1 ŸÖŸÑŸäŸàŸÜ' },
                        { v: '1m-1.5m', t: '1 ŸÖŸÑŸäŸàŸÜ - 1.5 ŸÖŸÑŸäŸàŸÜ' },
                        { v: '1.5m-2m', t: '1.5 ŸÖŸÑŸäŸàŸÜ - 2 ŸÖŸÑŸäŸàŸÜ' },
                        { v: '2m-3m', t: '2 ŸÖŸÑŸäŸàŸÜ - 3 ŸÖŸÑŸäŸàŸÜ' },
                        { v: 'above3m', t: 'ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 3 ŸÖŸÑŸäŸàŸÜ' }
                    ]
                    : [
                        { v: 'under500k', t: 'Under 500K' },
                        { v: '500k-1m', t: '500K - 1M' },
                        { v: '1m-1.5m', t: '1M - 1.5M' },
                        { v: '1.5m-2m', t: '1.5M - 2M' },
                        { v: '2m-3m', t: '2M - 3M' },
                        { v: 'above3m', t: 'Above 3M' }
                    ];
            }

            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.v;
                o.textContent = opt.t;
                sel.appendChild(o);
            });
        }

        function selectRooms(el) {
            document.querySelectorAll('#roomsChips .chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.rooms = el.dataset.rooms;
            checkBrokerFormValid();
        }

        function selectFamily(el) {
            document.querySelectorAll('#familyChips .chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.family = el.dataset.family;
            checkBrokerFormValid();
        }

        function selectTimeline(el) {
            document.querySelectorAll('#timelineChips .chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            brokerData.timeline = el.dataset.timeline;
            checkBrokerFormValid();
        }

        // Validate phone on input
        document.addEventListener('DOMContentLoaded', function() {
            const phoneEl = document.getElementById('brokerPhone');
            if (phoneEl) {
                phoneEl.addEventListener('input', checkBrokerFormValid);
            }

            const budgetEl = document.getElementById('budgetSelect');
            if (budgetEl) {
                budgetEl.addEventListener('change', checkBrokerFormValid);
            }
        });

        function checkBrokerFormValid() {
            const phone = document.getElementById('brokerPhone').value.trim();
            const budget = document.getElementById('budgetSelect').value;

            const isValid = brokerData.propertyType &&
                            brokerData.purpose &&
                            budget &&
                            brokerData.rooms &&
                            phone.length >= 9 &&
                            phone.startsWith('5');

            document.getElementById('brokerSubmitBtn').disabled = !isValid;
        }

        // ===== GOOGLE SHEETS CONFIG =====
        // ÿ∂ÿπ ÿ±ÿßÿ®ÿ∑ Google Apps Script ŸáŸÜÿß ÿ®ÿπÿØ ÿßŸÑÿ•ÿπÿØÿßÿØ:
        const GOOGLE_SHEETS_URL = '';  // ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ∂Ÿä ÿßŸÑÿ¢ŸÜÿå ÿπÿ®ŸëŸäŸá ÿ®ÿπÿØ ÿ•ÿπÿØÿßÿØ Google Sheets

        function submitBrokerForm() {
            const phone = document.getElementById('brokerPhone').value.trim();
            const budget = document.getElementById('budgetSelect').value;
            const notes = document.getElementById('brokerNotes').value.trim();
            const neighborhood = document.getElementById('resultNeighborhood').textContent;

            const requestData = {
                id: 'req_' + Date.now(),
                neighborhood: neighborhood,
                propertyType: brokerData.propertyType,
                purpose: brokerData.purpose,
                budget: budget,
                rooms: brokerData.rooms,
                family: brokerData.family || '',
                timeline: brokerData.timeline || '',
                notes: notes,
                phone: '+966' + phone,
                status: 'new',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('ar-SA'),
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
            };

            // 1) Save to localStorage
            saveLeadToLocal(requestData);

            // 2) Send to Google Sheets (if configured)
            if (GOOGLE_SHEETS_URL) {
                sendToGoogleSheets(requestData);
            }

            // Show success
            document.getElementById('brokerForm').classList.remove('show');
            document.getElementById('brokerSuccess').classList.add('show');
            document.getElementById('brokerSuccess').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            showToast(lang === 'ar' ? 'üéâ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ!' : 'üéâ Request sent!');
        }

        function saveLeadToLocal(data) {
            try {
                const leads = JSON.parse(localStorage.getItem('wainaskan_leads') || '[]');
                leads.unshift(data);
                localStorage.setItem('wainaskan_leads', JSON.stringify(leads));
            } catch (e) {
                console.error('Error saving lead:', e);
            }
        }

        function sendToGoogleSheets(data) {
            try {
                fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).catch(err => console.log('Sheets sync pending:', err));
            } catch (e) {
                console.log('Will sync later:', e);
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
